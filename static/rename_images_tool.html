<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›¾ç‰‡æ‰¹é‡é‡å‘½åå·¥å…·</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 800px;
      width: 100%;
    }
    
    h1 {
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
      font-size: 28px;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .step {
      background: #f8f9ff;
      border-left: 4px solid #667eea;
      padding: 15px 20px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    
    .step-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .file-input-wrapper {
      margin-top: 10px;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .file-btn {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .file-btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .file-name {
      display: inline-block;
      margin-left: 10px;
      color: #666;
      font-size: 14px;
    }
    
    .action-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
      transition: all 0.3s;
    }
    
    .action-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn-group .action-btn {
      margin-top: 0;
    }
    
    #log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      line-height: 1.6;
      display: none;
    }
    
    #log.show {
      display: block;
    }
    
    .log-success { color: #4ec9b0; }
    .log-error { color: #f48771; }
    .log-warning { color: #dcdcaa; }
    .log-info { color: #9cdcfe; }
    .log-header { color: #c586c0; font-weight: bold; }
    
    .progress {
      margin-top: 20px;
      display: none;
    }
    
    .progress.show {
      display: block;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a);
      width: 0%;
      transition: width 0.3s;
    }
    
    .progress-text {
      text-align: center;
      margin-top: 10px;
      color: #666;
      font-size: 14px;
    }
    
    .note {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px;
      border-radius: 6px;
      margin-top: 20px;
      font-size: 13px;
      line-height: 1.6;
    }
    
    .note strong {
      color: #d39e00;
    }
    
    .summary-box {
      background: #f0f4ff;
      border: 2px solid #667eea;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    
    .summary-box.show {
      display: block;
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 15px;
    }
    
    .summary-section {
      margin-bottom: 15px;
    }
    
    .summary-section-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      font-size: 15px;
    }
    
    .summary-list {
      background: white;
      padding: 10px 15px;
      border-radius: 4px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.8;
      color: #666;
    }
    
    .summary-list.empty {
      color: #4caf50;
      text-align: center;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¸ å›¾ç‰‡æ‰¹é‡é‡å‘½åå·¥å…·</h1>
    <p class="subtitle">æ ¹æ® Markdown æ–‡ä»¶ä¸­çš„å°æ ‡é¢˜é‡å‘½åå›¾ç‰‡</p>
    
    <div class="step">
      <div class="step-title">æ­¥éª¤ 1ï¸âƒ£ï¼šé€‰æ‹© Markdown æ–‡ä»¶</div>
      <div class="file-input-wrapper">
        <label for="mdFile" class="file-btn">ğŸ“„ é€‰æ‹© .md æ–‡ä»¶</label>
        <input type="file" id="mdFile" accept=".md,text/markdown">
        <span class="file-name" id="mdFileName">æœªé€‰æ‹©æ–‡ä»¶</span>
      </div>
    </div>
    
    <div class="step">
      <div class="step-title">æ­¥éª¤ 2ï¸âƒ£ï¼šé€‰æ‹©å›¾ç‰‡ç›®å½•</div>
      <div class="file-input-wrapper">
        <label for="imgDir" class="file-btn">ğŸ“ é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¤¹</label>
        <input type="file" id="imgDir" webkitdirectory directory multiple>
        <span class="file-name" id="imgDirName">æœªé€‰æ‹©æ–‡ä»¶å¤¹</span>
      </div>
    </div>
    
    <div class="btn-group">
      <button class="action-btn" id="checkBtn" disabled style="flex: 1;">ğŸ” æ£€æŸ¥æ–‡ä»¶</button>
    </div>
    
    <div class="btn-group">
      <button class="action-btn" id="renameBtn" disabled style="flex: 1;">ğŸ“¥ é€ä¸ªä¸‹è½½</button>
      <button class="action-btn" id="zipBtn" disabled style="flex: 1;">ğŸ“¦ ä¸‹è½½ä¸º ZIP</button>
    </div>
    
    <div class="progress" id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">å¤„ç†ä¸­...</div>
    </div>
    
    <div id="log"></div>
    
    <div class="summary-box" id="summary">
      <div class="summary-title">ğŸ“Š å¤„ç†æŠ¥å‘Š</div>
      
      <div class="summary-section">
        <div class="summary-section-title">âŒ Markdown ä¸­æœ‰ï¼Œä½†æœªæ‰¾åˆ°å›¾ç‰‡ï¼ˆå…± <span id="missingCount">0</span> ä¸ªï¼‰ï¼š</div>
        <div class="summary-list" id="missingList">æ— </div>
      </div>
      
      <div class="summary-section">
        <div class="summary-section-title">âš ï¸ å›¾ç‰‡ç›®å½•ä¸­æœ‰ï¼Œä½† Markdown ä¸­æœªæåŠï¼ˆå…± <span id="unusedCount">0</span> ä¸ªï¼‰ï¼š</div>
        <div class="summary-list" id="unusedList">æ— </div>
      </div>
    </div>
    
    <div class="note">
      <strong>âš ï¸ æ³¨æ„äº‹é¡¹ï¼š</strong><br>
      â€¢ æ­¤å·¥å…·ä¼šç”Ÿæˆé‡å‘½ååçš„æ–‡ä»¶ï¼ŒåŸæ–‡ä»¶ä¸ä¼šè¢«ä¿®æ”¹<br>
      â€¢ æ–°æ–‡ä»¶å‘½åæ ¼å¼ï¼šå°æ ‡é¢˜_åŸæ–‡ä»¶å<br>
      â€¢ è¯·ç¡®ä¿æµè§ˆå™¨å·²æˆæƒæ–‡ä»¶è®¿é—®æƒé™ï¼ˆæ¨èä½¿ç”¨ Chrome/Edgeï¼‰
    </div>
  </div>

  <script>
    let mdFile = null;
    let imageFiles = [];
    const log = document.getElementById('log');
    const checkBtn = document.getElementById('checkBtn');
    const renameBtn = document.getElementById('renameBtn');
    const zipBtn = document.getElementById('zipBtn');
    const progress = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const summary = document.getElementById('summary');
    
    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
      log.classList.add('show');
      const line = document.createElement('div');
      line.className = `log-${type}`;
      line.textContent = message;
      log.appendChild(line);
      log.scrollTop = log.scrollHeight;
    }
    
    // æ¸…ç©ºæ—¥å¿—
    function clearLog() {
      log.innerHTML = '';
    }
    
    // Markdown æ–‡ä»¶é€‰æ‹©
    document.getElementById('mdFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        mdFile = file;
        document.getElementById('mdFileName').textContent = file.name;
        checkReady();
      }
    });
    
    // å›¾ç‰‡ç›®å½•é€‰æ‹©
    document.getElementById('imgDir').addEventListener('change', (e) => {
      const files = Array.from(e.target.files).filter(f => 
        /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name)
      );
      if (files.length > 0) {
        imageFiles = files;
        document.getElementById('imgDirName').textContent = `${files.length} å¼ å›¾ç‰‡`;
        checkReady();
      }
    });
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹
    function checkReady() {
      const ready = !!(mdFile && imageFiles.length > 0);
      checkBtn.disabled = !ready;
      renameBtn.disabled = !ready;
      zipBtn.disabled = !ready;
    }
    
    // è§£æ Markdown
    function parseMarkdown(mdText) {
      const images = [];
      const regex = /!\[([^\]]*?)\]\(\s*(\S+?)(?:\s+"([^"]*?)")?\s*\)/g;
      let match;
      
      while ((match = regex.exec(mdText)) !== null) {
        const altText = match[1].trim();
        const url = match[2].trim();
        let caption = match[3] || altText;
        
        if (!caption || caption === '') {
          const beforeText = mdText.substring(0, match.index);
          const lines = beforeText.split('\n');
          for (let i = lines.length - 1; i >= 0; i--) {
            const line = lines[i].trim();
            if (line) {
              const titleMatch = line.match(/\*\*([^*]+)\*\*/);
              if (titleMatch) {
                caption = titleMatch[1].trim();
              } else if (!line.startsWith('!')) {
                caption = line.replace(/^#+\s*/, '').trim();
              }
              break;
            }
          }
        }
        
        const filename = url.split('/').pop().split('?')[0];
        images.push({ caption: caption || '', filename, url });
      }
      
      return images;
    }
    
    // ä¸‹è½½æ–‡ä»¶
    function downloadFile(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // æ¸…ç†æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦
    function sanitizeFileName(name) {
      // ç§»é™¤æˆ–æ›¿æ¢ Windows æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦: \ / : * ? " < > |
      return name.replace(/[\\/:*?"<>|]/g, '-')
                 .replace(/\s+/g, ' ')  // å¤šä¸ªç©ºæ ¼æ›¿æ¢ä¸ºå•ä¸ª
                 .trim();
    }
    
    // ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
    function generateSafeFileName(caption, originalFileName) {
      // æå–æ‰©å±•å
      const lastDotIndex = originalFileName.lastIndexOf('.');
      const ext = lastDotIndex > 0 ? originalFileName.substring(lastDotIndex) : '';
      const nameWithoutExt = lastDotIndex > 0 ? originalFileName.substring(0, lastDotIndex) : originalFileName;
      
      let finalName;
      if (caption && caption.trim()) {
        // æ¸…ç†å°æ ‡é¢˜
        const cleanCaption = sanitizeFileName(caption);
        // ç»„åˆï¼šå°æ ‡é¢˜_åŸæ–‡ä»¶å.æ‰©å±•å
        finalName = `${cleanCaption}_${nameWithoutExt}${ext}`;
      } else {
        finalName = originalFileName;
      }
      
      // é™åˆ¶æ€»é•¿åº¦ï¼ˆWindowsè·¯å¾„é™åˆ¶ï¼‰
      if (finalName.length > 200) {
        const extLength = ext.length;
        finalName = finalName.substring(0, 200 - extLength) + ext;
      }
      
      return finalName;
    }
    
    // æ™ºèƒ½åŒ¹é…æ–‡ä»¶å
    function findMatchingFile(targetFileName, fileList) {
      // å»æ‰æ‰©å±•å
      const targetBase = targetFileName.replace(/\.[^.]+$/, '');
      
      // ç­–ç•¥1: å®Œå…¨åŒ¹é…ï¼ˆå»æ‰æ‰©å±•åï¼‰
      let matched = fileList.find(f => {
        const fileBase = f.name.replace(/\.[^.]+$/, '');
        return fileBase === targetBase;
      });
      
      if (matched) return matched;
      
      // ç­–ç•¥2: åŒ…å«åŒ¹é…ï¼ˆå¤„ç†æµè§ˆå™¨æ·»åŠ çš„å‰ç¼€/åç¼€ï¼‰
      // ä¾‹å¦‚: network-asset-785894d3ly1hm16drlhupj215o1mytqx-20251218162011-ds0u60t.jpg
      // åº”è¯¥åŒ¹é…: 785894d3ly1hm16drlhupj215o1mytqx.jpg
      matched = fileList.find(f => {
        const fileBase = f.name.replace(/\.[^.]+$/, '');
        // æ£€æŸ¥æ–‡ä»¶åä¸­æ˜¯å¦åŒ…å«ç›®æ ‡æ–‡ä»¶å
        return fileBase.includes(targetBase);
      });
      
      if (matched) return matched;
      
      // ç­–ç•¥3: åå‘åŒ…å«ï¼ˆç›®æ ‡æ–‡ä»¶ååŒ…å«å®é™…æ–‡ä»¶åï¼‰
      matched = fileList.find(f => {
        const fileBase = f.name.replace(/\.[^.]+$/, '');
        return targetBase.includes(fileBase);
      });
      
      return matched || null;
    }
    
    // æ˜¾ç¤ºç»Ÿè®¡æŠ¥å‘Š
    function showSummary(missingFiles, unusedFiles) {
      summary.classList.add('show');
      
      // æœªæ‰¾åˆ°çš„æ–‡ä»¶
      const missingCount = document.getElementById('missingCount');
      const missingList = document.getElementById('missingList');
      missingCount.textContent = missingFiles.length;
      
      if (missingFiles.length > 0) {
        missingList.innerHTML = missingFiles.map(item => {
          if (item.caption) {
            return `â€¢ <strong>${item.caption}</strong> â†’ ${item.filename}`;
          } else {
            return `â€¢ ${item.filename}`;
          }
        }).join('<br>');
        missingList.classList.remove('empty');
      } else {
        missingList.textContent = 'âœ… æ‰€æœ‰å›¾ç‰‡éƒ½æ‰¾åˆ°äº†';
        missingList.classList.add('empty');
      }
      
      // æœªä½¿ç”¨çš„æ–‡ä»¶
      const unusedCount = document.getElementById('unusedCount');
      const unusedList = document.getElementById('unusedList');
      unusedCount.textContent = unusedFiles.length;
      
      if (unusedFiles.length > 0) {
        unusedList.innerHTML = unusedFiles.map(f => `â€¢ ${f}`).join('<br>');
        unusedList.classList.remove('empty');
      } else {
        unusedList.textContent = 'âœ… æ‰€æœ‰å›¾ç‰‡éƒ½åœ¨ Markdown ä¸­';
        unusedList.classList.add('empty');
      }
    }
    
    // æ£€æŸ¥æ–‡ä»¶ï¼ˆä¸ä¸‹è½½ï¼‰
    async function checkFiles() {
      clearLog();
      progress.classList.add('show');
      summary.classList.remove('show');
      checkBtn.disabled = true;
      renameBtn.disabled = true;
      zipBtn.disabled = true;
      
      addLog('========================================', 'header');
      addLog('å¼€å§‹æ£€æŸ¥æ–‡ä»¶...', 'header');
      addLog('========================================', 'header');
      addLog('');
      
      try {
        // è¯»å– Markdown
        addLog(`ğŸ“– è¯»å– Markdown æ–‡ä»¶: ${mdFile.name}`, 'info');
        const mdText = await mdFile.text();
        const mdImages = parseMarkdown(mdText);
        addLog(`âœ… æ‰¾åˆ° ${mdImages.length} å¼ å›¾ç‰‡ä¿¡æ¯`, 'success');
        addLog('');
        
        addLog(`ğŸ“ å›¾ç‰‡ç›®å½•ä¸­æœ‰ ${imageFiles.length} å¼ å›¾ç‰‡`, 'info');
        addLog('');
        
        let foundCount = 0;
        let skipCount = 0;
        const missingFiles = [];
        const processedFiles = [];
        
        // æ£€æŸ¥æ¯å¼ å›¾ç‰‡
        for (let i = 0; i < mdImages.length; i++) {
          const imgInfo = mdImages[i];
          const originalName = imgInfo.filename;
          
          // æ›´æ–°è¿›åº¦
          const percent = Math.round((i + 1) / mdImages.length * 100);
          progressFill.style.width = `${percent}%`;
          progressText.textContent = `æ£€æŸ¥ä¸­... ${i + 1}/${mdImages.length}`;
          
          // æŸ¥æ‰¾åŒ¹é…çš„æ–‡ä»¶ï¼ˆä½¿ç”¨æ™ºèƒ½åŒ¹é…ï¼‰
          const matchedFile = findMatchingFile(originalName, imageFiles);
          
          if (!matchedFile) {
            addLog(`âŒ æœªæ‰¾åˆ°ï¼š${originalName}`, 'error');
            if (imgInfo.caption) {
              addLog(`   å°æ ‡é¢˜ï¼š${imgInfo.caption}`, 'warning');
            }
            missingFiles.push({ filename: originalName, caption: imgInfo.caption });
            continue;
          }
          
          processedFiles.push(matchedFile.name);
          
          // æ„å»ºæ–°æ–‡ä»¶åï¼ˆä½¿ç”¨å®‰å…¨å‡½æ•°ï¼‰
          const newFileName = generateSafeFileName(imgInfo.caption, matchedFile.name);
          
          // å¦‚æœæ–‡ä»¶åç›¸åŒï¼Œè·³è¿‡
          if (matchedFile.name === newFileName) {
            addLog(`â­ï¸  ${matchedFile.name}ï¼ˆæ— éœ€é‡å‘½åï¼‰`, 'info');
            skipCount++;
          } else {
            addLog(`âœ… ${matchedFile.name}`, 'success');
            addLog(`   â†’ ${newFileName}`, 'info');
            foundCount++;
          }
        }
        
        // æŸ¥æ‰¾æœªä½¿ç”¨çš„æ–‡ä»¶
        const unusedFiles = imageFiles
          .filter(f => !processedFiles.includes(f.name))
          .map(f => f.name);
        
        addLog('');
        addLog('========================================', 'header');
        addLog('æ£€æŸ¥ç»“æœï¼š', 'header');
        addLog(`  éœ€è¦é‡å‘½å: ${foundCount} ä¸ª`, foundCount > 0 ? 'success' : 'info');
        addLog(`  æ— éœ€é‡å‘½å: ${skipCount} ä¸ª`, 'info');
        addLog(`  Markdown ä¸­æœ‰ä½†æœªæ‰¾åˆ°: ${missingFiles.length} ä¸ª`, missingFiles.length > 0 ? 'error' : 'success');
        addLog(`  å›¾ç‰‡ç›®å½•ä¸­æœ‰ä½†æœªä½¿ç”¨: ${unusedFiles.length} ä¸ª`, unusedFiles.length > 0 ? 'warning' : 'success');
        addLog('========================================', 'header');
        
        // æ˜¾ç¤ºè¯¦ç»†æŠ¥å‘Š
        showSummary(missingFiles, unusedFiles);
        
        if (missingFiles.length > 0) {
          addLog('');
          addLog('âš ï¸ è­¦å‘Šï¼šæœ‰æ–‡ä»¶ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥åå†ä¸‹è½½', 'warning');
        } else {
          addLog('');
          addLog('âœ… æ‰€æœ‰æ–‡ä»¶éƒ½å·²å‡†å¤‡å¥½ï¼Œå¯ä»¥å¼€å§‹ä¸‹è½½æˆ–æ‰“åŒ…', 'success');
        }
        
        progressText.textContent = `âœ… æ£€æŸ¥å®Œæˆï¼`;
        
      } catch (error) {
        addLog('', 'error');
        addLog(`âŒ å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
        console.error(error);
        progressText.textContent = 'âŒ æ£€æŸ¥å¤±è´¥';
      } finally {
        checkBtn.disabled = false;
        renameBtn.disabled = false;
        zipBtn.disabled = false;
      }
    }
    
    // æ ¸å¿ƒå¤„ç†é€»è¾‘
    async function processImages(downloadAsZip = false) {
      clearLog();
      progress.classList.add('show');
      summary.classList.remove('show');
      checkBtn.disabled = true;
      renameBtn.disabled = true;
      zipBtn.disabled = true;
      
      addLog('========================================', 'header');
      addLog(downloadAsZip ? 'å¼€å§‹å¤„ç†ï¼ˆæ‰“åŒ…ä¸º ZIPï¼‰...' : 'å¼€å§‹å¤„ç†ï¼ˆé€ä¸ªä¸‹è½½ï¼‰...', 'header');
      addLog('========================================', 'header');
      addLog('');
      
      try {
        // è¯»å– Markdown
        addLog(`ğŸ“– è¯»å– Markdown æ–‡ä»¶: ${mdFile.name}`, 'info');
        const mdText = await mdFile.text();
        const mdImages = parseMarkdown(mdText);
        addLog(`âœ… æ‰¾åˆ° ${mdImages.length} å¼ å›¾ç‰‡ä¿¡æ¯`, 'success');
        addLog('');
        
        addLog(`ğŸ“ å›¾ç‰‡ç›®å½•ä¸­æœ‰ ${imageFiles.length} å¼ å›¾ç‰‡`, 'info');
        addLog('');
        
        let successCount = 0;
        let skipCount = 0;
        const missingFiles = []; // MDä¸­æœ‰ä½†æ‰¾ä¸åˆ°çš„
        const processedFiles = []; // å·²å¤„ç†çš„æ–‡ä»¶å
        const zip = downloadAsZip ? new JSZip() : null;
        
        // å¤„ç†æ¯å¼ å›¾ç‰‡
        for (let i = 0; i < mdImages.length; i++) {
          const imgInfo = mdImages[i];
          const originalName = imgInfo.filename;
          
          // æ›´æ–°è¿›åº¦
          const percent = Math.round((i + 1) / mdImages.length * 100);
          progressFill.style.width = `${percent}%`;
          progressText.textContent = `å¤„ç†ä¸­... ${i + 1}/${mdImages.length}`;
          
          // æŸ¥æ‰¾åŒ¹é…çš„æ–‡ä»¶ï¼ˆä½¿ç”¨æ™ºèƒ½åŒ¹é…ï¼‰
          const matchedFile = findMatchingFile(originalName, imageFiles);
          
          if (!matchedFile) {
            addLog(`âš ï¸  è·³è¿‡ï¼šæœªæ‰¾åˆ°æ–‡ä»¶ "${originalName}"`, 'warning');
            if (imgInfo.caption) {
              addLog(`   å°æ ‡é¢˜ï¼š${imgInfo.caption}`, 'warning');
            }
            missingFiles.push({ filename: originalName, caption: imgInfo.caption });
            skipCount++;
            continue;
          }
          
          processedFiles.push(matchedFile.name);
          
          // æ„å»ºæ–°æ–‡ä»¶åï¼ˆä½¿ç”¨å®‰å…¨å‡½æ•°ï¼‰
          const newFileName = generateSafeFileName(imgInfo.caption, matchedFile.name);
          
          // å¦‚æœæ–‡ä»¶åç›¸åŒï¼Œè·³è¿‡
          if (matchedFile.name === newFileName) {
            addLog(`â­ï¸  è·³è¿‡ï¼š${matchedFile.name}ï¼ˆæ–‡ä»¶åå·²æ­£ç¡®ï¼‰`, 'info');
            skipCount++;
            continue;
          }
          
          addLog(`ğŸ“ ${matchedFile.name}`, 'info');
          addLog(`   â†’ ${newFileName}`, 'success');
          
          if (downloadAsZip) {
            // æ·»åŠ åˆ° ZIP
            const blob = await matchedFile.slice(0, matchedFile.size, matchedFile.type);
            zip.file(newFileName, blob);
          } else {
            // é€ä¸ªä¸‹è½½
            const blob = await matchedFile.slice(0, matchedFile.size, matchedFile.type);
            downloadFile(blob, newFileName);
            // é¿å…ä¸‹è½½å¤ªå¿«è¢«æµè§ˆå™¨é˜»æ­¢
            await new Promise(resolve => setTimeout(resolve, 300));
          }
          
          successCount++;
        }
        
        // å¦‚æœæ˜¯ ZIP æ¨¡å¼ï¼Œç”Ÿæˆå¹¶ä¸‹è½½
        if (downloadAsZip && successCount > 0) {
          addLog('');
          addLog('ğŸ“¦ æ­£åœ¨æ‰“åŒ… ZIP æ–‡ä»¶...', 'info');
          const content = await zip.generateAsync({ 
            type: 'blob',
            compression: "DEFLATE",
            compressionOptions: { level: 6 }
          });
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
          downloadFile(content, `renamed_images_${timestamp}.zip`);
          addLog('âœ… ZIP æ–‡ä»¶å·²ç”Ÿæˆ', 'success');
        }
        
        // æŸ¥æ‰¾æœªä½¿ç”¨çš„æ–‡ä»¶
        const unusedFiles = imageFiles
          .filter(f => !processedFiles.includes(f.name))
          .map(f => f.name);
        
        addLog('');
        addLog('========================================', 'header');
        addLog('å®Œæˆç»Ÿè®¡ï¼š', 'header');
        addLog(`  ${downloadAsZip ? 'å·²æ‰“åŒ…' : 'å·²ä¸‹è½½'}é‡å‘½åæ–‡ä»¶: ${successCount} ä¸ª`, 'success');
        addLog(`  è·³è¿‡: ${skipCount} ä¸ª`, 'warning');
        addLog(`  Markdown ä¸­æœ‰ä½†æœªæ‰¾åˆ°: ${missingFiles.length} ä¸ª`, missingFiles.length > 0 ? 'error' : 'success');
        addLog(`  å›¾ç‰‡ç›®å½•ä¸­æœ‰ä½†æœªä½¿ç”¨: ${unusedFiles.length} ä¸ª`, unusedFiles.length > 0 ? 'warning' : 'success');
        addLog('========================================', 'header');
        
        // æ˜¾ç¤ºè¯¦ç»†æŠ¥å‘Š
        showSummary(missingFiles, unusedFiles);
        
        if (downloadAsZip) {
          addLog('');
          addLog('ğŸ’¡ æç¤ºï¼šZIP æ–‡ä»¶å·²ä¸‹è½½åˆ°é»˜è®¤ä¸‹è½½ç›®å½•', 'info');
        } else {
          addLog('');
          addLog('ğŸ’¡ æç¤ºï¼šé‡å‘½ååçš„æ–‡ä»¶å·²ä¸‹è½½åˆ°é»˜è®¤ä¸‹è½½ç›®å½•', 'info');
        }
        
        progressText.textContent = `âœ… å®Œæˆï¼å·²å¤„ç† ${successCount} ä¸ªæ–‡ä»¶`;
        
      } catch (error) {
        addLog('', 'error');
        addLog(`âŒ å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
        console.error(error);
        progressText.textContent = 'âŒ å¤„ç†å¤±è´¥';
      } finally {
        checkBtn.disabled = false;
        renameBtn.disabled = false;
        zipBtn.disabled = false;
      }
    }
    
    // æ£€æŸ¥æ–‡ä»¶æŒ‰é’®
    checkBtn.addEventListener('click', async () => {
      await checkFiles();
    });
    
    // é€ä¸ªä¸‹è½½æŒ‰é’®
    renameBtn.addEventListener('click', async () => {
      await processImages(false);
    });
    
    // ZIP ä¸‹è½½æŒ‰é’®
    zipBtn.addEventListener('click', async () => {
      await processImages(true);
    });
  </script>
</body>
</html>
