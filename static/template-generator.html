
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoteroç¬”è®°æ¨¡æ¿ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #F2F2F2;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .panel {
            padding: 30px;
        }

        .config-panel {
            border-bottom: 2px solid #F2F2F2;
        }

        .code-panel {
            background: #FAFAFA;
            max-height: 600px;
            overflow-y: auto;
        }

        h1 {
            color: #222222;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #9C9C9C;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .author-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 12px;
            color: #9C9C9C;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .author-info:hover {
            opacity: 1;
        }

        .author-info .author-name {
            color: #9C9C9C;
            font-weight: normal;
        }

        .author-info .separator {
            color: #9C9C9C;
        }

        .author-info a {
            color: #9C9C9C;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .author-info a:hover {
            color: #0069E0;
        }

        .section {
            background: #FAFAFA;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #E8E8E8;
        }

        .config-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .config-sections {
                grid-template-columns: 1fr;
            }
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #222222;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333333;
            font-size: 14px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="color"],
        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #E8E8E8;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
            color: #222222;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #0069E0;
        }

        input[type="color"] {
            height: 40px;
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #E8E8E8;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #333333;
        }
        
        .radio-item input[type="radio"]:disabled + label {
            color: #999999;
            cursor: not-allowed;
        }

        input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        input[type="radio"]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .metadata-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            max-height: 250px;
            overflow-y: auto;
        }

        .section-list {
            margin-top: 15px;
        }

        .section-card {
            background: white;
            border: 2px solid #0069E0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .section-card-header {
            display: grid;
            grid-template-columns: 1fr 150px 80px;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #F2F2F2;
        }

        .section-card-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .section-card-label {
            font-size: 12px;
            color: #9C9C9C;
            font-weight: 500;
        }

        .section-card-title {
            font-weight: 600;
            color: #222222;
            font-size: 15px;
        }

        .subsection-list {
            margin-top: 10px;
        }

        .subsection-header {
            display: grid;
            grid-template-columns: 200px 1fr 40px;
            gap: 10px;
            padding: 8px 10px;
            background: #f0f0f0;
            font-weight: 600;
            color: #555;
            border-radius: 4px;
            font-size: 13px;
        }

        .subsection-item {
            display: grid;
            grid-template-columns: 200px 1fr 40px;
            gap: 10px;
            padding: 8px 10px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-top: none;
            align-items: center;
        }

        .subsection-item:last-child {
            border-radius: 0 0 4px 4px;
        }

        .subsection-item input[type="text"] {
            padding: 6px 10px;
            font-size: 13px;
        }

        .btn-remove {
            background: #DB2C3A;
            color: white;
            border: none;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            width: 32px;
            height: 32px;
        }

        .btn-remove:hover {
            background: #C02030;
        }

        .btn-add-sub {
            background: #0069E0;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
        }

        .btn-add-sub:hover {
            background: #0055B8;
        }

        .btn-add {
            background: #0069E0;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }

        .btn-add:hover {
            background: #0055B8;
        }

        .btn-import {
            background: #6D6D6D;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            margin-left: 10px;
            font-size: 14px;
        }

        .btn-import:hover {
            background: #555555;
        }

        .old-section-item {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #0069E0;
            color: white;
        }

        .btn-primary:hover {
            background: #0055B8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 105, 224, 0.3);
        }

        .btn-secondary {
            background: #F5F5F5;
            color: #333;
            border: 1px solid #E0E0E0;
        }

        .btn-secondary:hover {
            background: #E8E8E8;
            border-color: #CCCCCC;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background: #DB2C3A;
            color: white;
        }

        .btn-danger:hover {
            background: #C02030;
        }

        .checkbox-group {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 20px;
            margin-bottom: 12px;
            min-width: 150px;
        }
        
        .metadata-fields {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .fields-section {
            margin-bottom: 16px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 15px;
            background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
            border: 1px solid #DEE2E6;
            border-radius: 6px;
            margin-bottom: 12px;
            user-select: none;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .section-header:hover {
            background: linear-gradient(135deg, #E9ECEF 0%, #DEE2E6 100%);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .section-header .arrow {
            transition: transform 0.3s;
            font-size: 16px;
            color: #495057;
            font-weight: bold;
        }
        
        .section-header .arrow.collapsed {
            transform: rotate(-90deg);
        }
        
        .section-header .title {
            font-weight: 600;
            color: #212529;
            font-size: 14px;
        }
        
        .section-header .count {
            color: #6C757D;
            font-size: 13px;
            margin-left: auto;
            background: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .collapsible-content {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
        }
        
        .collapsible-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin: 0;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .color-picker-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-preview {
            display: none; /* éšè—é¢„è§ˆæ¡†ï¼Œç›´æ¥ä½¿ç”¨color picker */
        }

        input[type="color"] {
            width: 60px;
            height: 35px;
            border: 1px solid #E8E8E8;
            border-radius: 4px;
            cursor: pointer;
            padding: 2px;
        }
        
        .section-item {
            background: white;
            border: 1px solid #E8E8E8;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .section-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .sub-item {
            background: #FAFAFA;
            border-left: 3px solid #0069E0;
            padding: 10px;
            margin: 8px 0 8px 20px;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .code-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .drag-handle {
            cursor: move;
            color: #9C9C9C;
            margin-right: 10px;
        }

        .emoji-picker {
            width: 60px;
        }

        small {
            color: #9C9C9C;
            font-size: 12px;
        }

        .help-btn {
            display: inline-block;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            background: #6D6D6D;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            margin-left: 8px;
            position: relative;
        }

        .help-btn:hover {
            background: #555555;
        }

        .help-btn .tooltip {
            visibility: hidden;
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: #222222;
            color: white;
            padding: 12px 15px;
            border-radius: 6px;
            white-space: pre-line;
            font-size: 13px;
            line-height: 1.6;
            z-index: 1000;
            min-width: 350px;
            max-width: 450px;
            text-align: left;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .help-btn:hover .tooltip {
            visibility: visible;
        }

        .help-btn .tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: #222222;
        }

        .preview-hint {
            background: #FFF9E6;
            border: 1px solid #FFE5A0;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #6D6D6D;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§é…ç½®é¢æ¿ -->
        <div class="panel config-panel">
            <h1>ğŸ“ Zoteroç¬”è®°æ¨¡æ¿ç”Ÿæˆå™¨
                <span class="help-btn">?
                    <span class="tooltip">ğŸ“– ç¬”è®°æ¨¡æ¿æ·»åŠ æ–¹å¼ï¼š
1. å®‰è£…Better Notes æ’ä»¶
2. æ‰“å¼€æ¨¡æ¿ç¼–è¾‘å™¨
   Zotero > ç¼–è¾‘ > è®¾ç½® > Better Notes
   å‘ä¸‹æ»šåŠ¨ï¼Œåœ¨æ¨¡æ¿éƒ¨åˆ†ç‚¹å‡»"æ‰“å¼€æ¨¡æ¿ç¼–è¾‘å™¨"æŒ‰é’®
3. æ–°å»ºæ¨¡æ¿ï¼šä¸‹æ–¹ "é€‰é¡¹" > "å¯¼å…¥ç¬”è®°æ¨¡æ¿: å‰ªè´´æ¿ä¸­çš„æ¨¡æ¿åˆ†äº«ä»£ç "
4. å¼¹å‡ºæç¤ºåé€‰æ‹©okï¼Œå³å¯åœ¨æ¨¡æ¿æœ«å°¾çœ‹åˆ°æ–°å»ºæ¨¡æ¿
   æ¨¡æ¿åç§°é»˜è®¤ä¸ è‡ªå®šä¹‰æ ‡é¢˜å‰ç¼€ ä¸€è‡´
   ç•™ç©ºåˆ™ä¸º Note with Meta Data
   æ³¨æ„ï¼šåŒåæ¨¡æ¿ä¼šè¦†ç›–ä»…ä¿ç•™æœ€è¿‘ç‰ˆ</span>
                </span>
            </h1>
            <p class="subtitle">å¯è§†åŒ–é…ç½®Better Notesæ¨¡æ¿</p>

            <!-- æ ‡é¢˜è®¾ç½® -->
            <div class="section" style="margin-bottom: 20px;">
                <div class="section-title">ğŸ·ï¸ ç¬”è®°æ ‡é¢˜è®¾ç½®</div>
                
                <div class="form-group">
                    <label>è‡ªå®šä¹‰æ ‡é¢˜å‰ç¼€ (å¯ç•™ç©º)</label>
                    <input type="text" id="customTitlePrefix" placeholder="ä¾‹å¦‚: ã€é˜…è¯»ç¬”è®°ã€‘ã€Reading Notes: ç­‰">
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="appendOriginalTitle" checked>
                    <label for="appendOriginalTitle">åœ¨è‡ªå®šä¹‰æ ‡é¢˜åè¿½åŠ åŸæ–‡æ ‡é¢˜</label>
                </div>
                
                <small style="color: #999; display: block; margin-top: 8px;">
                    ğŸ’¡ å¦‚æœä¸å¡«å†™è‡ªå®šä¹‰æ ‡é¢˜ä¸”ä¸å‹¾é€‰è¿½åŠ ,å°†åªæ˜¾ç¤ºåŸæ–‡æ ‡é¢˜
                </small>
            </div>

            <!-- å…ƒæ•°æ®æ¨¡å— -->
            <div class="section">
                <div class="section-title">ğŸ’¡ å…ƒæ•°æ®æ¨¡å—</div>
                
                <div class="form-row-3">
                    <div class="form-group">
                        <label>è¯­è¨€</label>
                        <select id="metaLang">
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>é¢œè‰²1</label>
                        <div class="color-picker-wrapper">
                            <input type="color" id="metaColor1" value="#dbeedd">
                            <input type="text" id="metaColorText1" value="#dbeedd" style="width: 90px;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>é¢œè‰²2</label>
                        <div class="color-picker-wrapper">
                            <input type="color" id="metaColor2" value="#f3faf4">
                            <input type="text" id="metaColorText2" value="#f3faf4" style="width: 90px;">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>å¯é€‰å…ƒæ•°æ®å­—æ®µ (å‹¾é€‰åä»…åœ¨å­˜åœ¨æ—¶æ˜¾ç¤º)</label>
                    <div style="margin-bottom: 12px;">
                        <button type="button" class="btn-secondary" onclick="selectCommonFields()">å¿«é€‰ï¼šå¸¸ç”¨å­—æ®µ</button>
                        <button type="button" class="btn-secondary" onclick="selectAllFields()">å…¨é€‰</button>
                        <button type="button" class="btn-secondary" onclick="deselectAllFields()">å…¨ä¸é€‰</button>
                    </div>
                    
                    <div id="metadataFields" style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- å¸¸ç”¨å­—æ®µ (ä¸æŠ˜å ) -->
                        <div>
                            <h4 style="color: #1B5E20; margin-bottom: 12px; font-size: 14px;">å¸¸ç”¨å­—æ®µ</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_title" checked>
                                    <label for="field_title">æ ‡é¢˜</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_creators" checked>
                                    <label for="field_creators">ä½œè€…</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_date" checked>
                                    <label for="field_date">æ—¥æœŸ</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_publicationTitle" checked>
                                    <label for="field_publicationTitle">æœŸåˆŠï¼ˆå¸¦æ ‡ç­¾ï¼‰</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_doi" checked>
                                    <label for="field_doi">DOI</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_attachmentLink" checked>
                                    <label for="field_attachmentLink">é™„ä»¶ï¼ˆå¸¦é“¾æ¥ï¼‰</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_abstract">
                                    <label for="field_abstract">æ‘˜è¦</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_year">
                                    <label for="field_year">å¹´ä»½</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_language">
                                    <label for="field_language">è¯­è¨€</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_itemType">
                                    <label for="field_itemType">æ–‡çŒ®ç±»å‹</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_url">
                                    <label for="field_url">URL</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_pages">
                                    <label for="field_pages">é¡µç </label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_volume">
                                    <label for="field_volume">å·</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_issue">
                                    <label for="field_issue">æœŸå·</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_tags">
                                    <label for="field_tags">æ ‡ç­¾</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_extra">
                                    <label for="field_extra">é™„åŠ ä¿¡æ¯</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_titleTranslation" onchange="toggleTitleTranslationOptions()">
                                    <label for="field_titleTranslation">æ ‡é¢˜ç¿»è¯‘</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_abstractTranslation" onchange="toggleAbstractTranslationOptions()">
                                    <label for="field_abstractTranslation">æ‘˜è¦ç¿»è¯‘</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å…¶ä»–å­—æ®µ (å¯æŠ˜å ) -->
                        <div>
                            <div class="section-header" onclick="toggleOtherFields()">
                                <span id="otherFieldsToggleIcon" class="arrow">â–¼</span>
                                <span class="title">å…¶ä»–å­—æ®µ</span>
                                <span class="count">å±•å¼€æŸ¥çœ‹æ›´å¤š</span>
                            </div>
                        </div>
                        
                        <div id="otherFieldsContainer" style="display: none; padding: 15px; background: #F8F9FA; border: 1px solid #DEE2E6; border-radius: 6px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_isbn">
                                    <label for="field_isbn">ISBN</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_issn">
                                    <label for="field_issn">ISSN</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_accessDate">
                                    <label for="field_accessDate">è®¿é—®æ—¥æœŸ</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_libraryCatalog">
                                    <label for="field_libraryCatalog">æ–‡åº“ç¼–ç›®</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_shortTitle">
                                    <label for="field_shortTitle">çŸ­æ ‡é¢˜</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_journalAbbreviation">
                                    <label for="field_journalAbbreviation">æœŸåˆŠç¼©å†™</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_publisher">
                                    <label for="field_publisher">å‡ºç‰ˆç¤¾</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_place">
                                    <label for="field_place">å‡ºç‰ˆåœ°</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_edition">
                                    <label for="field_edition">ç‰ˆæœ¬</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_series">
                                    <label for="field_series">ç³»åˆ—</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_seriesNumber">
                                    <label for="field_seriesNumber">ç³»åˆ—ç¼–å·</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_bookTitle">
                                    <label for="field_bookTitle">å›¾ä¹¦æ ‡é¢˜</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_conferenceName">
                                    <label for="field_conferenceName">ä¼šè®®åç§°</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_university">
                                    <label for="field_university">å¤§å­¦</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_thesisType">
                                    <label for="field_thesisType">å­¦ä½ç±»å‹</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_reportType">
                                    <label for="field_reportType">æŠ¥å‘Šç±»å‹</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_reportNumber">
                                    <label for="field_reportNumber">æŠ¥å‘Šç¼–å·</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_archive">
                                    <label for="field_archive">æ¡£æ¡ˆ</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_archiveLocation">
                                    <label for="field_archiveLocation">æ¡£æ¡ˆä½ç½®</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_callNumber">
                                    <label for="field_callNumber">ç´¢ä¹¦å·</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_rights">
                                    <label for="field_rights">æƒåˆ©</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_key">
                                    <label for="field_key">é¡¹ç›®é”®</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_id">
                                    <label for="field_id">é¡¹ç›®ID</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_libraryID">
                                    <label for="field_libraryID">å›¾ä¹¦é¦†ID</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_dateAdded">
                                    <label for="field_dateAdded">æ·»åŠ æ—¥æœŸ</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_dateModified">
                                    <label for="field_dateModified">ä¿®æ”¹æ—¥æœŸ</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_attachmentCount">
                                    <label for="field_attachmentCount">é™„ä»¶æ•°é‡</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_attachmentName">
                                    <label for="field_attachmentName">é™„ä»¶åç§°</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_noteCount">
                                    <label for="field_noteCount">å­ç¬”è®°æ•°é‡</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ ‡é¢˜ç¿»è¯‘æ˜¾ç¤ºæ–¹å¼ <span style="color: #999; font-size: 12px;">(éœ€å…ˆå‹¾é€‰"æ ‡é¢˜ç¿»è¯‘"å­—æ®µ)</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="titleOption1" name="titleTranslation" value="show" checked disabled>
                            <label for="titleOption1">å•ç‹¬æ˜¾ç¤ºç¿»è¯‘</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="titleOption2" name="titleTranslation" value="replace" disabled>
                            <label for="titleOption2">è¦†ç›–åŸæ–‡</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ‘˜è¦ç¿»è¯‘æ˜¾ç¤ºæ–¹å¼ <span style="color: #999; font-size: 12px;">(éœ€å…ˆå‹¾é€‰"æ‘˜è¦ç¿»è¯‘"å­—æ®µ)</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="abstractOption1" name="abstractTranslation" value="show" checked disabled>
                            <label for="abstractOption1">å•ç‹¬æ˜¾ç¤ºç¿»è¯‘</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="abstractOption2" name="abstractTranslation" value="replace" disabled>
                            <label for="abstractOption2">è¦†ç›–åŸæ–‡</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ—¥æœŸä¸ä½œè€…æ˜¾ç¤ºæ–¹å¼</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="dateAuthorsOption1" name="dateAuthorsDisplay" value="merged" checked>
                            <label for="dateAuthorsOption1">åˆå¹¶æ˜¾ç¤º</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="dateAuthorsOption2" name="dateAuthorsDisplay" value="separate">
                            <label for="dateAuthorsOption2">åˆ†å¼€æ˜¾ç¤º</label>
                        </div>
                    </div>
                    <small style="color: #999; display: block; margin-top: 5px;">
                        ğŸ’¡ åˆå¹¶æ˜¾ç¤º: 2023 - John Smith; Jane Doe (èŠ‚çœç©ºé—´)
                    </small>
                </div>
            </div>

            <!-- ç¬”è®°ç« èŠ‚ -->
            <div class="section">
                <div class="section-title">ğŸ“’ ç¬”è®°ç« èŠ‚

                </div>
                
                <div class="section-list">

                    <div id="noteSections"></div>
                </div>
                
                <div style="margin-top: 10px;">
                    <button class="btn-add" onclick="addSection()">â• æ·»åŠ ç« èŠ‚</button>
                    <button class="btn-import" onclick="importFromClipboard()" style="margin-left: 10px;">ğŸ“‹ ä»å‰ªè´´æ¿å¯¼å…¥å¤§æ ‡é¢˜å’Œé…è‰²</button>
                    <span class="help-btn" style="margin-left: 5px;">?
                        <span class="tooltip">1. å¦‚æœ‰Styleä¸”è®¾ç½®äº†æ ‡æ³¨é¢œè‰²å¯ä»¥ä½¿ç”¨
2. æ‰“å¼€æ ‡æ³¨é¢œè‰²ç®¡ç†ï¼šæœ‰ä¸¤ç§æ–¹å¼
   â‘  Shift+P > æ ‡æ³¨
   â‘¡ Zotero > ç¼–è¾‘ > è®¾ç½® > Style
      å‘ä¸‹æ»šåŠ¨ é˜…è¯»ç•Œé¢ > æ ‡æ³¨é¢œè‰² > ç¼–è¾‘
3. å¯¼å‡ºé¢œè‰²ç»„ï¼šåœ¨å·¦ä¾§é€‰æ‹©Group
   ç¡®å®šåç‚¹å‡»å³ä¸Šè§’çš„Export
   å°†æ ‡æ³¨åå’Œé¢œè‰²å¤åˆ¶åˆ°ç²˜è´´æ¿ä¸­
4. å¯¼å…¥æ¨¡æ¿ç¼–è¾‘å™¨ï¼šç‚¹å‡»å¯¼å…¥
   åŸæ ‡æ³¨åä¼šè¯†åˆ«ä¸ºç« èŠ‚åç§°
   é¢œè‰²ä¼šè¯†åˆ«ä¸ºç« èŠ‚æ ‡é¢˜çš„åº•è‰²

å¯¼å…¥æ ¼å¼ç¤ºä¾‹ï¼š
[["æ ¸å¿ƒè´¡çŒ®","#FFEB3B"],["ç®—æ³•æ ¸å¿ƒ","#42A5F5"]]

ç¬¬ä¸€ä¸ªä¸ºç« èŠ‚æ ‡é¢˜ï¼Œç¬¬äºŒä¸ªä¸ºèƒŒæ™¯é¢œè‰²</span>
                    </span>
                    <button class="btn-import" onclick="importFromMarkdown()" style="margin-left: 10px;">ğŸ“ ä»å‰ªè´´æ¿å¯¼å…¥Markdownæ ¼å¼</button>
                    <span class="help-btn" style="margin-left: 5px;">?
                        <span class="tooltip">Markdownæ ¼å¼ç¤ºä¾‹ï¼š
## äºŒçº§æ ‡é¢˜ï¼ˆç¬”è®°çš„ä¸»è¦æ–¹é¢ï¼Œå¦‚ç ”ç©¶èƒŒæ™¯ï¼‰
### ä¸‰çº§æ ‡é¢˜ï¼ˆä¸»è¦æ–¹é¢çš„å­æ–¹é¢ï¼Œå¦‚ç†è®ºåŸºç¡€ï¼‰
<æç¤º>ï¼ˆå¡«å†™çš„æç¤ºï¼Œå¯¹ä¸‰çº§æ ‡é¢˜å†…å®¹çš„ç®€å•æè¿°ï¼Œå¦‚<ç ”ç©¶åŸºäºçš„ç†è®ºåŸºç¡€>ï¼Œéœ€è¦ç”¨"<>"åŒ…è£¹ï¼‰

å¯ä»¥å¸¦```ä¹Ÿå¯ä»¥ä¸å¸¦</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢„è§ˆ/ä»£ç é¢æ¿ -->
        <div class="panel code-panel">
            <div class="preview-hint">
                ğŸ’¡ æç¤ºï¼šä½¿ç”¨ <code>$</code> è¡¨ç¤ºçš„å†…å®¹å¯¼å…¥Better Notesåä¼šè¢«æ›¿æ¢ï¼Œè¯·å¿½ç•¥
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generateCode()">ğŸ”„ ç”Ÿæˆä»£ç </button>
                <button class="btn btn-secondary" onclick="previewTemplate()">ğŸ‘ï¸ é¢„è§ˆæ•ˆæœ</button>
                <button class="btn btn-secondary" onclick="copyCode()">ğŸ“‹ å¤åˆ¶ä»£ç </button>
                <button class="btn btn-secondary" onclick="downloadCode()">ğŸ’¾ ä¸‹è½½æ¨¡æ¿</button>
            </div>
            <div class="code-output" id="codeOutput">ç‚¹å‡»"ç”Ÿæˆä»£ç "æŒ‰é’®æ¥ç”Ÿæˆæ¨¡æ¿ä»£ç ...</div>
        </div>
    </div>

    <script>
        // å­—æ®µå¿«æ·é€‰æ‹©å‡½æ•°
        function selectCommonFields() {
            // å¸¸ç”¨å­—æ®µé»˜è®¤é€‰æ‹©ï¼šæ ‡é¢˜ã€ä½œè€…ã€æ—¥æœŸã€æœŸåˆŠã€DOIã€é™„ä»¶
            const commonFields = ['title', 'creators', 'date', 'publicationTitle', 'doi', 'attachmentLink'];
            const allCheckboxes = document.querySelectorAll('#metadataFields input[type="checkbox"]');
            
            allCheckboxes.forEach(cb => {
                const fieldName = cb.id.replace('field_', '');
                cb.checked = commonFields.includes(fieldName);
            });
        }
        
        function selectAllFields() {
            const allCheckboxes = document.querySelectorAll('#metadataFields input[type="checkbox"]');
            allCheckboxes.forEach(cb => cb.checked = true);
            // è§¦å‘ç¿»è¯‘é€‰é¡¹çš„æ˜¾ç¤º
            toggleTitleTranslationOptions();
            toggleAbstractTranslationOptions();
        }
        
        function deselectAllFields() {
            const allCheckboxes = document.querySelectorAll('#metadataFields input[type="checkbox"]');
            allCheckboxes.forEach(cb => cb.checked = false);
            // è§¦å‘ç¿»è¯‘é€‰é¡¹çš„ç¦ç”¨
            toggleTitleTranslationOptions();
            toggleAbstractTranslationOptions();
        }
        
        // æŠ˜å /å±•å¼€å…¶ä»–å­—æ®µ
        function toggleOtherFields() {
            const container = document.getElementById('otherFieldsContainer');
            const icon = document.getElementById('otherFieldsToggleIcon');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.textContent = 'â–¼';
                icon.classList.remove('collapsed');
            } else {
                container.style.display = 'none';
                icon.textContent = 'â–¶';
                icon.classList.add('collapsed');
            }
        }
        
        // å¯ç”¨/ç¦ç”¨æ ‡é¢˜ç¿»è¯‘é€‰é¡¹
        function toggleTitleTranslationOptions() {
            const checkbox = document.getElementById('field_titleTranslation');
            const option1 = document.getElementById('titleOption1');
            const option2 = document.getElementById('titleOption2');
            
            option1.disabled = !checkbox.checked;
            option2.disabled = !checkbox.checked;
        }
        
        // å¯ç”¨/ç¦ç”¨æ‘˜è¦ç¿»è¯‘é€‰é¡¹
        function toggleAbstractTranslationOptions() {
            const checkbox = document.getElementById('field_abstractTranslation');
            const option1 = document.getElementById('abstractOption1');
            const option2 = document.getElementById('abstractOption2');
            
            option1.disabled = !checkbox.checked;
            option2.disabled = !checkbox.checked;
        }
    
        // é¢œè‰²é€‰æ‹©å™¨åŒæ­¥
        function setupColorPicker(colorId, textId) {
            const colorInput = document.getElementById(colorId);
            const textInput = document.getElementById(textId);

            colorInput.addEventListener('input', (e) => {
                textInput.value = e.target.value;
            });

            textInput.addEventListener('input', (e) => {
                if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                    colorInput.value = e.target.value;
                }
            });
        }

        setupColorPicker('metaColor1', 'metaColorText1');
        setupColorPicker('metaColor2', 'metaColorText2');

        // ç« èŠ‚ç®¡ç†
        let sectionCount = 0;
        let sections = {}; // å­˜å‚¨æ‰€æœ‰ç« èŠ‚æ•°æ®

        // æ·»åŠ ç« èŠ‚
        function addSection(title = 'æ ¸å¿ƒè´¡çŒ®', bgColor = '#FFEB3B') {
            sectionCount++;
            const sectionId = sectionCount;
            
            sections[sectionId] = {
                title: title,
                bgColor: bgColor,
                subsections: []
            };
            
            renderSections();
        }

        // æ·»åŠ å­ç« èŠ‚
        function addSubsection(sectionId) {
            if (!sections[sectionId].subsections) {
                sections[sectionId].subsections = [];
            }
            sections[sectionId].subsections.push({
                title: '',
                prompt: ''
            });
            renderSections();
        }

        // åˆ é™¤ç« èŠ‚
        function deleteSection(sectionId) {
            delete sections[sectionId];
            renderSections();
        }

        // åˆ é™¤å­ç« èŠ‚
        function deleteSubsection(sectionId, subIndex) {
            sections[sectionId].subsections.splice(subIndex, 1);
            renderSections();
        }

        // æ›´æ–°ç« èŠ‚æ ‡é¢˜
        function updateSectionTitle(sectionId, value) {
            if (sections[sectionId]) {
                sections[sectionId].title = value;
            }
        }

        // æ›´æ–°ç« èŠ‚é¢œè‰²
        function updateSectionColor(sectionId, value) {
            if (sections[sectionId]) {
                sections[sectionId].bgColor = value;
            }
        }

        // æ›´æ–°å­ç« èŠ‚
        function updateSubsection(sectionId, subIndex, field, value) {
            if (sections[sectionId] && sections[sectionId].subsections[subIndex]) {
                sections[sectionId].subsections[subIndex][field] = value;
            }
        }

        // æ¸²æŸ“æ‰€æœ‰ç« èŠ‚
        function renderSections() {
            const container = document.getElementById('noteSections');
            container.innerHTML = '';
            
            Object.keys(sections).forEach(sectionId => {
                const section = sections[sectionId];
                const card = document.createElement('div');
                card.className = 'section-card';
                
                let subsectionsHtml = '';
                if (section.subsections && section.subsections.length > 0) {
                    subsectionsHtml = `
                        <div class="subsection-list">
                            <div class="subsection-header">
                                <div>å­ç« èŠ‚æ ‡é¢˜</div>
                                <div>å­ç« èŠ‚æç¤º</div>
                                <div>æ“ä½œ</div>
                            </div>
                            ${section.subsections.map((sub, subIndex) => `
                                <div class="subsection-item">
                                    <input type="text" 
                                           value="${sub.title || ''}" 
                                           placeholder="ä¾‹å¦‚: ç ”ç©¶æ–¹æ³•"
                                           onchange="updateSubsection(${sectionId}, ${subIndex}, 'title', this.value)">
                                    <input type="text" 
                                           value="${sub.prompt || ''}" 
                                           placeholder="ä¾‹å¦‚: ä½œè€…ä½¿ç”¨äº†ä»€ä¹ˆç ”ç©¶æ–¹æ³•ï¼Ÿ"
                                           onchange="updateSubsection(${sectionId}, ${subIndex}, 'prompt', this.value)">
                                    <button class="btn-remove" 
                                            onclick="deleteSubsection(${sectionId}, ${subIndex})" 
                                            title="åˆ é™¤">âœ•</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <div class="section-card-header">
                        <div class="section-card-field">
                            <label class="section-card-label">ç« èŠ‚æ ‡é¢˜</label>
                            <input type="text" 
                                   class="section-card-title"
                                   value="${section.title}" 
                                   placeholder="ä¾‹å¦‚: æ ¸å¿ƒè´¡çŒ®"
                                   onchange="updateSectionTitle(${sectionId}, this.value)">
                        </div>
                        <div class="section-card-field">
                            <label class="section-card-label">èƒŒæ™¯è‰²</label>
                            <div class="color-picker-wrapper">
                                <input type="color" 
                                       id="sectionColor${sectionId}" 
                                       value="${section.bgColor}"
                                       onchange="updateSectionColor(${sectionId}, this.value); document.getElementById('sectionColorText${sectionId}').value = this.value;">
                                <input type="text" 
                                       id="sectionColorText${sectionId}" 
                                       value="${section.bgColor}" 
                                       style="width: 70px;"
                                       onchange="updateSectionColor(${sectionId}, this.value); document.getElementById('sectionColor${sectionId}').value = this.value;">
                            </div>
                        </div>
                        <button class="btn-remove" onclick="deleteSection(${sectionId})" title="åˆ é™¤ç« èŠ‚" style="margin-top: 20px;">âœ•</button>
                    </div>
                    ${subsectionsHtml}
                    <button class="btn-add-sub" onclick="addSubsection(${sectionId})">â• æ·»åŠ å­ç« èŠ‚</button>
                `;
                
                container.appendChild(card);
            });
        }

        // ä»å‰ªè´´æ¿å¯¼å…¥ç« èŠ‚ï¼ˆJSONæ ¼å¼ï¼‰
        async function importFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                // å°è¯•è§£æJSONæ•°ç»„: [["æ ¸å¿ƒè´¡çŒ®","#FFEB3B"],["ç®—æ³•æ ¸å¿ƒ","#42A5F5"],...]
                const importData = JSON.parse(text);
                
                if (!Array.isArray(importData)) {
                    throw new Error('å‰ªè´´æ¿å†…å®¹ä¸æ˜¯æ•°ç»„æ ¼å¼');
                }
                
                // æ¸…ç©ºç°æœ‰ç« èŠ‚
                sections = {};
                sectionCount = 0;
                
                // æ·»åŠ å¯¼å…¥çš„ç« èŠ‚
                importData.forEach(([title, color]) => {
                    if (title && color) {
                        addSection(title, color);
                    }
                });
                
                alert(`æˆåŠŸå¯¼å…¥ ${importData.length} ä¸ªç« èŠ‚ï¼`);
            } catch (error) {
                alert(`å¯¼å…¥å¤±è´¥ï¼š${error.message}\n\nè¯·ç¡®ä¿å‰ªè´´æ¿å†…å®¹æ ¼å¼ä¸ºï¼š\n[["æ ‡é¢˜1","#é¢œè‰²1"],["æ ‡é¢˜2","#é¢œè‰²2"]]`);
            }
        }

        // ä»å‰ªè´´æ¿å¯¼å…¥Markdownæ ¼å¼
        async function importFromMarkdown() {
            try {
                let text = await navigator.clipboard.readText();
                
                // ç§»é™¤ä»£ç å—æ ‡è®°ï¼ˆå¦‚æœæœ‰ï¼‰
                text = text.replace(/^```[\s\S]*?\n/, '').replace(/\n```$/, '').trim();
                
                // æ¸…ç©ºç°æœ‰ç« èŠ‚
                sections = {};
                sectionCount = 0;
                
                const lines = text.split('\n');
                let currentSection = null;
                let currentSubsection = null;
                let importCount = 0;
                
                // é»˜è®¤é¢œè‰²æ± 
                const defaultColors = ['#FFEB3B', '#42A5F5', '#66BB6A', '#FF7043', '#AB47BC', '#26C6DA', '#FFA726'];
                let colorIndex = 0;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (!line) continue;
                    
                    // åŒ¹é…äºŒçº§æ ‡é¢˜ ## æ ‡é¢˜ï¼ˆä¸»è¦ç« èŠ‚ï¼‰
                    const h2Match = line.match(/^##\s+(.+)/);
                    if (h2Match && !line.match(/^###/)) {  // ç¡®ä¿ä¸æ˜¯###
                        const title = h2Match[1].trim();
                        const color = defaultColors[colorIndex % defaultColors.length];
                        colorIndex++;
                        
                        addSection(title, color);
                        currentSection = sectionCount;
                        currentSubsection = null;
                        importCount++;
                        continue;
                    }
                    
                    // åŒ¹é…ä¸‰çº§æ ‡é¢˜ ### æ ‡é¢˜ï¼ˆå­ç« èŠ‚ï¼‰
                    const h3Match = line.match(/^###\s+(.+)/);
                    if (h3Match && currentSection !== null) {
                        const title = h3Match[1].trim();
                        currentSubsection = { title: title, prompt: '' };
                        
                        // æ£€æŸ¥ä¸‹ä¸€è¡Œæ˜¯å¦æœ‰æç¤º
                        if (i + 1 < lines.length) {
                            const nextLine = lines[i + 1].trim();
                            const promptMatch = nextLine.match(/^<(.+)>$/);
                            if (promptMatch) {
                                currentSubsection.prompt = promptMatch[1].trim();
                                i++; // è·³è¿‡ä¸‹ä¸€è¡Œ
                            }
                        }
                        
                        if (!sections[currentSection].subsections) {
                            sections[currentSection].subsections = [];
                        }
                        sections[currentSection].subsections.push(currentSubsection);
                        continue;
                    }
                    
                    // åŒ¹é…ç‹¬ç«‹çš„æç¤ºè¡Œï¼ˆå¯èƒ½äºŒçº§æ ‡é¢˜å’Œæç¤ºä¸è¿ç»­ï¼‰
                    const promptMatch = line.match(/^<(.+)>$/);
                    if (promptMatch && currentSubsection) {
                        currentSubsection.prompt = promptMatch[1].trim();
                    }
                }
                
                renderSections();
                
                if (importCount === 0) {
                    throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„Markdownæ ‡é¢˜');
                }
                
                alert(`æˆåŠŸå¯¼å…¥ ${importCount} ä¸ªç« èŠ‚ï¼`);
            } catch (error) {
                alert(`å¯¼å…¥å¤±è´¥ï¼š${error.message}\n\nè¯·ä½¿ç”¨å¦‚ä¸‹æ ¼å¼ï¼š\n## äºŒçº§æ ‡é¢˜\n### ä¸‰çº§æ ‡é¢˜\n<æç¤º>`);
            }
        }

        // ç”Ÿæˆä»£ç 
        // å­—æ®µé…ç½®æ˜ å°„
        const FIELD_CONFIG = {
            // é€šç”¨å­—æ®µ
            title: { zoteroField: 'title', labelZh: 'æ ‡é¢˜', labelEn: 'Title' },
            creators: { zoteroField: 'creators', labelZh: 'ä½œè€…', labelEn: 'Authors', isComplex: true },
            date: { zoteroField: 'date', labelZh: 'æ—¥æœŸ', labelEn: 'Date' },
            year: { zoteroField: 'date', labelZh: 'å¹´ä»½', labelEn: 'Year', transform: (val) => val?.substring(0,4) },
            itemType: { zoteroField: 'itemType', labelZh: 'æ–‡çŒ®ç±»å‹', labelEn: 'Type', isComplex: true },
            extra: { zoteroField: 'extra', labelZh: 'é™„åŠ ä¿¡æ¯', labelEn: 'Extra' },
            tags: { zoteroField: 'tags', labelZh: 'æ ‡ç­¾', labelEn: 'Tags', isComplex: true },
            
            // å¸¸ç”¨å­—æ®µ
            abstract: { zoteroField: 'abstractNote', labelZh: 'æ‘˜è¦', labelEn: 'Abstract' },
            publicationTitle: { zoteroField: 'publicationTitle', labelZh: 'æœŸåˆŠ/å‡ºç‰ˆç‰©', labelEn: 'Publication' },
            language: { zoteroField: 'language', labelZh: 'è¯­è¨€', labelEn: 'Language' },
            url: { zoteroField: 'url', labelZh: 'URL', labelEn: 'URL' },
            accessDate: { zoteroField: 'accessDate', labelZh: 'è®¿é—®æ—¥æœŸ', labelEn: 'Access Date' },
            libraryCatalog: { zoteroField: 'libraryCatalog', labelZh: 'æ–‡åº“ç¼–ç›®', labelEn: 'Library Catalog' },
            
            // é¡µç å’Œå·æœŸ
            pages: { zoteroField: 'pages', labelZh: 'é¡µç ', labelEn: 'Pages' },
            volume: { zoteroField: 'volume', labelZh: 'å·', labelEn: 'Volume' },
            issue: { zoteroField: 'issue', labelZh: 'æœŸå·', labelEn: 'Issue' },
            
            // å‡ºç‰ˆä¿¡æ¯
            publisher: { zoteroField: 'publisher', labelZh: 'å‡ºç‰ˆç¤¾', labelEn: 'Publisher' },
            place: { zoteroField: 'place', labelZh: 'å‡ºç‰ˆåœ°', labelEn: 'Place' },
            edition: { zoteroField: 'edition', labelZh: 'ç‰ˆæœ¬', labelEn: 'Edition' },
            
            // æ ‡é¢˜ç›¸å…³
            shortTitle: { zoteroField: 'shortTitle', labelZh: 'çŸ­æ ‡é¢˜', labelEn: 'Short Title' },
            
            // ç³»åˆ—
            series: { zoteroField: 'series', labelZh: 'ç³»åˆ—', labelEn: 'Series' },
            seriesNumber: { zoteroField: 'seriesNumber', labelZh: 'ç³»åˆ—ç¼–å·', labelEn: 'Series Number' },
            
            // ç‰¹å®šç±»å‹
            bookTitle: { zoteroField: 'bookTitle', labelZh: 'å›¾ä¹¦æ ‡é¢˜', labelEn: 'Book Title' },
            conferenceName: { zoteroField: 'conferenceName', labelZh: 'ä¼šè®®åç§°', labelEn: 'Conference' },
            university: { zoteroField: 'university', labelZh: 'å¤§å­¦', labelEn: 'University' },
            thesisType: { zoteroField: 'thesisType', labelZh: 'å­¦ä½ç±»å‹', labelEn: 'Thesis Type' },
            reportType: { zoteroField: 'reportType', labelZh: 'æŠ¥å‘Šç±»å‹', labelEn: 'Report Type' },
            reportNumber: { zoteroField: 'reportNumber', labelZh: 'æŠ¥å‘Šç¼–å·', labelEn: 'Report Number' },
            
            // æœŸåˆŠç›¸å…³
            journalAbbreviation: { zoteroField: 'journalAbbreviation', labelZh: 'æœŸåˆŠç¼©å†™', labelEn: 'Journal Abbr.' },
            
            // æ¡£æ¡ˆ
            archive: { zoteroField: 'archive', labelZh: 'æ¡£æ¡ˆ', labelEn: 'Archive' },
            archiveLocation: { zoteroField: 'archiveLocation', labelZh: 'æ¡£æ¡ˆä½ç½®', labelEn: 'Archive Location' },
            callNumber: { zoteroField: 'callNumber', labelZh: 'ç´¢ä¹¦å·', labelEn: 'Call Number' },
            rights: { zoteroField: 'rights', labelZh: 'æƒåˆ©', labelEn: 'Rights' },
            
            // ç³»ç»Ÿå­—æ®µ
            key: { zoteroField: 'key', labelZh: 'é¡¹ç›®é”®', labelEn: 'Key' },
            id: { zoteroField: 'id', labelZh: 'é¡¹ç›®ID', labelEn: 'ID', isComplex: true },
            libraryID: { zoteroField: 'libraryID', labelZh: 'å›¾ä¹¦é¦†ID', labelEn: 'Library ID', isComplex: true },
            dateAdded: { zoteroField: 'dateAdded', labelZh: 'æ·»åŠ æ—¥æœŸ', labelEn: 'Date Added' },
            dateModified: { zoteroField: 'dateModified', labelZh: 'ä¿®æ”¹æ—¥æœŸ', labelEn: 'Date Modified' }
        };
    
        function generateCode() {
            const lang = document.getElementById('metaLang').value;
            const color1 = document.getElementById('metaColorText1').value;
            const color2 = document.getElementById('metaColorText2').value;
            
            const customTitlePrefix = document.getElementById('customTitlePrefix').value.trim();
            const appendOriginalTitle = document.getElementById('appendOriginalTitle').checked;
            
            // åªæœ‰å‹¾é€‰äº†ç¿»è¯‘å­—æ®µæ‰è¯»å–ç¿»è¯‘é€‰é¡¹
            const titleTranslationChecked = document.getElementById('field_titleTranslation').checked;
            const titleTranslationOption = titleTranslationChecked ? document.querySelector('input[name="titleTranslation"]:checked').value : 'none';
            
            const abstractTranslationChecked = document.getElementById('field_abstractTranslation').checked;
            const abstractTranslationOption = abstractTranslationChecked ? document.querySelector('input[name="abstractTranslation"]:checked').value : 'none';
            
            const dateAuthorsDisplay = document.querySelector('input[name="dateAuthorsDisplay"]:checked').value;
            
            const langText = {
                zh: {
                    metaTitle: 'å…ƒæ•°æ®',
                    title: 'æ ‡é¢˜',
                    titleTranslation: 'æ ‡é¢˜ç¿»è¯‘',
                    journal: 'æœŸåˆŠ',
                    dateAuthors: 'æ—¥æœŸä¸ä½œè€…',
                    language: 'è¯­è¨€',
                    itemType: 'æ–‡çŒ®ç±»å‹',
                    doi: 'DOI',
                    url: 'é“¾æ¥',
                    pages: 'é¡µç ',
                    volume: 'å·æœŸ',
                    attachment: 'é™„ä»¶',
                    abstract: 'æ‘˜è¦',
                    abstractTranslation: 'æ‘˜è¦ç¿»è¯‘'
                },
                en: {
                    metaTitle: 'Metadata',
                    title: 'Title',
                    titleTranslation: 'Title Translation',
                    journal: 'Journal (with tags)',
                    dateAuthors: 'Date & Authors',
                    language: 'Language',
                    itemType: 'Item Type',
                    doi: 'DOI',
                    url: 'URL',
                    pages: 'Pages',
                    volume: 'Volume/Issue',
                    attachment: 'Attachment',
                    abstract: 'Abstract',
                    abstractTranslation: 'Abstract Translation'
                }
            };

            const t = langText[lang];
            
            // ç”Ÿæˆæ ‡é¢˜é€»è¾‘
            let titleCode = '';
            if (customTitlePrefix && appendOriginalTitle) {
                // æœ‰å‰ç¼€ä¸”è¿½åŠ åŸæ ‡é¢˜ (ä¸­é—´åŠ ç©ºæ ¼)
                titleCode = `<h1 style="text-align: center">${customTitlePrefix} \${topItem.getField('title') || 'æ— æ ‡é¢˜'}</h1>\n`;
            } else if (customTitlePrefix && !appendOriginalTitle) {
                // åªæœ‰å‰ç¼€,ä¸è¿½åŠ åŸæ ‡é¢˜
                titleCode = `<h1 style="text-align: center">${customTitlePrefix}</h1>\n`;
            } else {
                // æ²¡æœ‰å‰ç¼€,æ˜¾ç¤ºåŸæ ‡é¢˜
                titleCode = `<h1 style="text-align: center">\${topItem.getField('title') || 'æ— æ ‡é¢˜'}</h1>\n`;
            }
            
            let code = titleCode;
            code += `<hr/>\n`;
            code += `<!-- ğŸ“Œ ä»¥ä¸‹æ˜¯å…ƒæ•°æ®è¡¨æ ¼ï¼Œç”±ä»£ç è‡ªåŠ¨ç”Ÿæˆï¼Œå†…å®¹å¯ä»¥å‚è€ƒä½†è¯·å‹¿ä¿®æ”¹ -->\n`;
            code += `<h2 style="color: #1B5E20; background-color:#F1F8E9;">ğŸ’¡ ${t.metaTitle}</h2>\n\n`;
            code += `<table>\n`;
            
            // å¯é€‰å­—æ®µ: æ ‡é¢˜
            let useColor = color1;
            
            if (document.getElementById('field_title').checked) {
                const replaceTitleWithTranslation = titleTranslationOption === 'replace';
                const showTitleTranslation = titleTranslationOption === 'show';
                
                if (replaceTitleWithTranslation) {
                    code += `    <tr>\n        <th style="background-color:${useColor}; text-align: left;">${t.title}</th>\n`;
                    code += `        <td style="background-color:${useColor};">\${{
            try {
                const titleTranslation = Zotero.PDFTranslate?.data?.ztoolkit?.ExtraField?.getExtraField(topItem, "titleTranslation");
                return titleTranslation && titleTranslation.trim() ? titleTranslation : topItem.getField('title');
            } catch (e) {
                return topItem.getField('title');
            }
        }}\$</td>\n    </tr>\n`;
                } else {
                    code += `    <tr>\n        <th style="background-color:${useColor}; text-align: left;">${t.title}</th>\n`;
                    code += `        <td style="background-color:${useColor};">\${topItem.getField('title') || 'æ— æ ‡é¢˜'}</td>\n    </tr>\n`;
                    useColor = useColor === color1 ? color2 : color1;
                    
                    if (showTitleTranslation) {
                        code += `    \${{
        try {
            const titleTranslation = Zotero.PDFTranslate?.data?.ztoolkit?.ExtraField?.getExtraField(topItem, "titleTranslation");
            if (titleTranslation && titleTranslation.trim()) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.titleTranslation}</th>
                    <td style="background-color:${useColor}; font-style: italic;">\${titleTranslation}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                        useColor = useColor === color1 ? color2 : color1;
                    }
                }
            } else {
                useColor = useColor === color1 ? color2 : color1;
            }

            // å¯é€‰å­—æ®µ: æœŸåˆŠ (å¯é€‰æ˜¾ç¤ºï¼Œæ²¡æœ‰åˆ™ä¸æ˜¾ç¤º)
            if (document.getElementById('field_publicationTitle') && document.getElementById('field_publicationTitle').checked) {
                code += `    \${{
        try {
            const publicationTitle = topItem.getField('publicationTitle');
            if (publicationTitle) {
                let tagsHtml = '';
                try {
                    const nodes = Zotero.ZoteroStyle.api.renderCell(topItem, "publicationTags").childNodes;
                    if (nodes && nodes.length) {
                        tagsHtml = ' ' + Array.prototype.map.call(nodes, e => {
                            e.style.marginLeft = '4px';
                            e.style.marginRight = '4px';
                            return e.outerHTML;
                        }).join(' ');
                    }
                } catch (e) {}
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.journal}</th>
                    <td style="background-color:${useColor};">\${publicationTitle}\${tagsHtml}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            // å¯é€‰å­—æ®µ: æ—¥æœŸä¸ä½œè€…
            const dateChecked = document.getElementById('field_date').checked;
            const authorsChecked = document.getElementById('field_creators') && document.getElementById('field_creators').checked;
            
            if (dateAuthorsDisplay === 'merged' && (dateChecked || authorsChecked)) {
                // åˆå¹¶æ˜¾ç¤ºæ¨¡å¼
                code += `    <tr>\n        <th style="background-color:${useColor}; text-align: left;">${t.dateAuthors}</th>\n`;
                code += `        <td style="background-color:${useColor};">\${topItem.getField('date')?.substring(0,4) || 'æ— å¹´ä»½'} - 
            \${topItem.getCreators()?.length 
                ? topItem.getCreators().map(v => \`\${v.firstName || ''} \${v.lastName || ''}\`).join("; ").trim() 
                : 'æ— ä½œè€…ä¿¡æ¯'}</td>\n    </tr>\n`;
                useColor = useColor === color1 ? color2 : color1;
            } else {
                // åˆ†å¼€æ˜¾ç¤ºæ¨¡å¼
                if (dateChecked) {
                    code += `    <tr>\n        <th style="background-color:${useColor}; text-align: left;">æ—¥æœŸ</th>\n`;
                    code += `        <td style="background-color:${useColor};">\${topItem.getField('date')?.substring(0,4) || 'æ— å¹´ä»½'}</td>\n    </tr>\n`;
                    useColor = useColor === color1 ? color2 : color1;
                }
                
                if (authorsChecked) {
                    code += `    <tr>\n        <th style="background-color:${useColor}; text-align: left;">ä½œè€…</th>\n`;
                    code += `        <td style="background-color:${useColor};">\${topItem.getCreators()?.length 
                ? topItem.getCreators().map(v => \`\${v.firstName || ''} \${v.lastName || ''}\`).join("; ").trim() 
                : 'æ— ä½œè€…ä¿¡æ¯'}</td>\n    </tr>\n`;
                    useColor = useColor === color1 ? color2 : color1;
                }
            }
            
            // å…¶ä»–å¯é€‰å­—æ®µ
            
            if (document.getElementById('field_language').checked) {
                code += `    \${{
        try {
            const language = topItem.getField('language');
            if (language) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.language}</th>
                    <td style="background-color:${useColor};">\${language}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            if (document.getElementById('field_itemType').checked) {
                code += `    \${{
        try {
            const itemType = topItem.itemType;
            if (itemType) {
                const typeNames = {
                    'journalArticle': 'æœŸåˆŠè®ºæ–‡',
                    'conferencePaper': 'ä¼šè®®è®ºæ–‡',
                    'book': 'ä¹¦ç±',
                    'bookSection': 'ä¹¦ç±ç« èŠ‚',
                    'thesis': 'å­¦ä½è®ºæ–‡',
                    'report': 'æŠ¥å‘Š'
                };
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.itemType}</th>
                    <td style="background-color:${useColor};">\${typeNames[itemType] || itemType}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            // DOIåœ¨åé¢çš„"å…¶ä»–é€šç”¨å­—æ®µ"éƒ¨åˆ†ç»Ÿä¸€å¤„ç†ï¼Œæ­¤å¤„ä¸å†ç”Ÿæˆ

            if (document.getElementById('field_url').checked) {
                code += `    \${{
        try {
            const url = topItem.getField('url');
            if (url) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.url}</th>
                    <td style="background-color:${useColor};">
                        <a href="\${url}">\${url.length > 50 ? url.substring(0, 47) + '...' : url}</a>
                    </td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            if (document.getElementById('field_pages').checked) {
                code += `    \${{
        try {
            const pages = topItem.getField('pages');
            if (pages) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.pages}</th>
                    <td style="background-color:${useColor};">\${pages}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            if (document.getElementById('field_volume').checked) {
                code += `    \${{
        try {
            const volume = topItem.getField('volume');
            const issue = topItem.getField('issue');
            if (volume || issue) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.volume}</th>
                    <td style="background-color:${useColor};">
                        \${volume ? \`Vol. \${volume}\` : ''}\${volume && issue ? ', ' : ''}\${issue ? \`No. \${issue}\` : ''}
                    </td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            if (document.getElementById('field_attachmentLink') && document.getElementById('field_attachmentLink').checked) {
                code += `    \${(() => {
        try {
            const attachments = topItem.getAttachments();
            if (attachments && attachments.length) {
                const attachment = Zotero.Items.get(attachments[0]);
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">é™„ä»¶</th>
                    <td style="background-color:${useColor};">
                        <a href="zotero://open-pdf/0_\${attachment.key}">\${attachment.getFilename() || 'é™„ä»¶'}</a>
                    </td>
                </tr>
                \`;
            }
            return '';
        } catch (e) {
            return '';
        }
    })()}\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            // æ‘˜è¦
            const replaceAbstractWithTranslation = abstractTranslationOption === 'replace';
            const showAbstractTranslation = abstractTranslationOption === 'show';
            
            if (document.getElementById('field_abstract').checked) {
                if (replaceAbstractWithTranslation) {
                    code += `    \${{
        try {
            const abstractTranslation = Zotero.PDFTranslate?.data?.ztoolkit?.ExtraField?.getExtraField(topItem, "abstractTranslation");
            const abstract = topItem.getField('abstractNote');
            const content = abstractTranslation && abstractTranslation.trim() ? abstractTranslation : abstract;
            if (content && content.trim()) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left; vertical-align: top;">${t.abstract}</th>
                    <td style="background-color:${useColor}; text-align: justify; line-height: 1.6;">\${content}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                } else {
                    code += `    \${{
        try {
            const abstract = topItem.getField('abstractNote');
            if (abstract && abstract.trim()) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left; vertical-align: top;">${t.abstract}</th>
                    <td style="background-color:${useColor}; text-align: justify; line-height: 1.6;">\${abstract}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                    useColor = useColor === color1 ? color2 : color1;
                    
                    if (showAbstractTranslation) {
                        code += `    \${{
        try {
            const abstractTranslation = Zotero.PDFTranslate?.data?.ztoolkit?.ExtraField?.getExtraField(topItem, "abstractTranslation");
            if (abstractTranslation && abstractTranslation.trim()) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left; vertical-align: top;">${t.abstractTranslation}</th>
                    <td style="background-color:${useColor}; text-align: justify; line-height: 1.6; font-style: italic;">\${abstractTranslation}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                        useColor = useColor === color1 ? color2 : color1;
                    }
                }
            }
            
            // å¤„ç†å…¶ä»–é€šç”¨å­—æ®µ (titleTranslation å’Œ abstractTranslation ç”±æ ‡é¢˜/æ‘˜è¦å­—æ®µçš„ç¿»è¯‘é€‰é¡¹å¤„ç†)
            const simpleFields = [
                'shortTitle', 'year', 'volume', 'issue', 'publisher', 'place', 'edition',
                'series', 'seriesNumber', 'bookTitle', 'conferenceName',
                'university', 'thesisType', 'reportType', 'reportNumber',
                'journalAbbreviation', 'archive', 'archiveLocation', 
                'callNumber', 'rights', 'extra'
            ];
            
            simpleFields.forEach(fieldName => {
                const fieldId = 'field_' + fieldName;
                const checkbox = document.getElementById(fieldId);
                if (!checkbox || !checkbox.checked) return;
                
                const config = FIELD_CONFIG[fieldName];
                if (!config) return;
                
                const label = lang === 'zh' ? config.labelZh : config.labelEn;
                const zField = config.zoteroField;
                
                // ç‰¹æ®Šå¤„ç†ç¿»è¯‘å­—æ®µ
                if (fieldName === 'titleTranslation' || fieldName === 'abstractTranslation') {
                    code += `    \${{
        try {
            const value = Zotero.PDFTranslate?.data?.ztoolkit?.ExtraField?.getExtraField(topItem, "${fieldName}");
            if (value && value.trim()) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${label}</th>
                    <td style="background-color:${useColor}; font-style: italic;">\${value}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                } else {
                    code += `    \${{
        try {
            const value = topItem.getField('${zField}');
            if (value) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${label}</th>
                    <td style="background-color:${useColor};">\${value}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                }
                useColor = useColor === color1 ? color2 : color1;
            });
            
            // DOI å’Œ ISBN ISSN ç‰¹æ®Šå¤„ç†
            if (document.getElementById('field_doi') && document.getElementById('field_doi').checked) {
                code += `    \${topItem.getField('DOI') ? \`
    <tr>
        <th style="background-color:${useColor}; text-align: left;">DOI</th>
        <td style="background-color:${useColor};">
            <a href="https://doi.org/\${topItem.getField('DOI')}">\${topItem.getField('DOI')}</a>
        </td>
    </tr>
    \` : ''}\n`;
                useColor = useColor === color1 ? color2 : color1;
            }
            
            if (document.getElementById('field_isbn') && document.getElementById('field_isbn').checked) {
                code += `    \${{
        try {
            const isbn = topItem.getField('ISBN');
            if (isbn) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">ISBN</th>
                    <td style="background-color:${useColor};">\${isbn}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }
            
            if (document.getElementById('field_issn') && document.getElementById('field_issn').checked) {
                code += `    \${{
        try {
            const issn = topItem.getField('ISSN');
            if (issn) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">ISSN</th>
                    <td style="background-color:${useColor};">\${issn}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }
            
            // æ ‡ç­¾
            if (document.getElementById('field_tags') && document.getElementById('field_tags').checked) {
                code += `    \${{
        try {
            const tags = topItem.getTags();
            if (tags && tags.length > 0) {
                const tagStr = tags.map(t => t.tag).join(', ');
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">æ ‡ç­¾</th>
                    <td style="background-color:${useColor};">\${tagStr}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }
            
            // ç³»ç»Ÿå­—æ®µ
            const systemFields = ['key', 'id', 'libraryID', 'dateAdded', 'dateModified'];
            systemFields.forEach(fieldName => {
                const checkbox = document.getElementById('field_' + fieldName);
                if (!checkbox || !checkbox.checked) return;
                
                const config = FIELD_CONFIG[fieldName];
                const label = lang === 'zh' ? config.labelZh : config.labelEn;
                
                if (fieldName === 'id' || fieldName === 'libraryID') {
                    code += `    \${{
        try {
            const value = topItem.${fieldName};
            if (value !== undefined && value !== null) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${label}</th>
                    <td style="background-color:${useColor};">\${value}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                } else {
                    code += `    \${{
        try {
            const value = topItem.getField('${config.zoteroField}');
            if (value) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${label}</th>
                    <td style="background-color:${useColor};">\${value}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                }
                useColor = useColor === color1 ? color2 : color1;
            });
            
            // é™„ä»¶ç›¸å…³å­—æ®µ
            const attachmentFields = [
                { id: 'attachmentCount', label: 'é™„ä»¶æ•°é‡', code: 'topItem.getAttachments().length' },
                { id: 'noteCount', label: 'å­ç¬”è®°æ•°é‡', code: 'topItem.getNotes().length' }
            ];
            
            attachmentFields.forEach(field => {
                const checkbox = document.getElementById('field_' + field.id);
                if (!checkbox || !checkbox.checked) return;
                
                code += `    \${{
        try {
            const value = ${field.code};
            if (value !== undefined) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${field.label}</th>
                    <td style="background-color:${useColor};">\${value}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            });
            
            // é™„ä»¶åç§°å’Œé“¾æ¥
            if (document.getElementById('field_attachmentName') && document.getElementById('field_attachmentName').checked) {
                code += `    \${{
        try {
            const attachments = topItem.getAttachments();
            if (attachments && attachments.length) {
                const attachment = Zotero.Items.get(attachments[0]);
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">é™„ä»¶åç§°</th>
                    <td style="background-color:${useColor};">\${attachment.getFilename() || 'æ— åç§°'}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }
            
            // é™„ä»¶é“¾æ¥å·²åœ¨å‰é¢çš„"å¸¸ç”¨å­—æ®µ"éƒ¨åˆ†å¤„ç†ï¼Œæ­¤å¤„ä¸å†é‡å¤ç”Ÿæˆ

            code += `</table>\n\n`;
            code += `<!-- âœï¸ ä»¥ä¸‹æ˜¯ç¬”è®°å†…å®¹éƒ¨åˆ†ï¼Œè¯·æ ¹æ® <> ä¸­çš„æç¤ºå’Œæ–‡çŒ®åŸæ–‡è¿›è¡Œå¡«å†™ -->\n\n`;

            // ç”Ÿæˆç« èŠ‚
            Object.keys(sections).forEach(sectionId => {
                const section = sections[sectionId];
                code += `<h2 style="background: ${section.bgColor}; color: #000; padding: 10px 15px; border-radius: 4px; margin-top: 30px;">${section.title}</h2>\n`;
                
                if (section.subsections && section.subsections.length > 0) {
                    section.subsections.forEach(sub => {
                        if (sub.title) {
                            code += `<p><strong>${sub.title}</strong>`;
                            if (sub.prompt) {
                                code += `: <span style="color: #666; "><${sub.prompt}></span>`;
                            }
                            code += `</p>\n`;
                        }
                    });
                } else {
                    code += `<p>åœ¨æ­¤å¡«å†™å†…å®¹...</p>\n`;
                }
                
                code += `\n`;
            });

            document.getElementById('codeOutput').textContent = code;
        }

        // é¢„è§ˆæ¨¡æ¿
        function previewTemplate() {
            const code = document.getElementById('codeOutput').textContent;
            if (code === 'ç‚¹å‡»"ç”Ÿæˆä»£ç "æŒ‰é’®æ¥ç”Ÿæˆæ¨¡æ¿ä»£ç ...') {
                alert('è¯·å…ˆç”Ÿæˆä»£ç ï¼');
                return;
            }
            
            // åˆ›å»ºé¢„è§ˆHTMLï¼ŒåŒ…å«æ ·å¼
            const previewHTML = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ¿é¢„è§ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e0e0e0;
        }
        th {
            font-weight: 600;
            width: 150px;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        h2 {
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 30px;
        }
        hr {
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 10px 0;
        }
        p {
            line-height: 1.8;
            margin: 10px 0;
        }
        a {
            color: #667eea;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    ${code}
</body>
</html>`;
            
            // åœ¨æ–°çª—å£ä¸­æ‰“å¼€é¢„è§ˆ
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(previewHTML);
            previewWindow.document.close();
        }

        // ç”Ÿæˆæ¨¡æ¿åˆ†äº«ä»£ç ï¼ˆå¸¦å¤´ä¿¡æ¯ï¼‰
        function generateTemplateShareCode() {
            const code = document.getElementById('codeOutput').textContent;
            if (code === 'ç‚¹å‡»"ç”Ÿæˆä»£ç "æŒ‰é’®æ¥ç”Ÿæˆæ¨¡æ¿ä»£ç ...') {
                return null;
            }
            
            // è·å–æ¨¡æ¿åç§°ï¼šä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰æ ‡é¢˜å‰ç¼€ï¼Œç•™ç©ºåˆ™é»˜è®¤ä¸º Note with Meta Data
            const customTitlePrefix = document.getElementById('customTitlePrefix').value.trim();
            const templateName = customTitlePrefix || 'Note with Meta Data';
            
            // è·å–å½“å‰æ—¶é—´ ISO æ ¼å¼
            const savedAt = new Date().toISOString();
            
            // ç”Ÿæˆå¤´ä¿¡æ¯
            const header = `# Instruction:
            # Open Better Notes template editor, click Options->Import Note Template: Template Sharing Code in Clipboard.
            # Generated by Zotero Template Generator V2 https://stream-l.github.io/template-generator.html
name: "[item] ${templateName}"
savedAt: "${savedAt}"
content: |-`;
            
            // å°†ä»£ç å†…å®¹ç¼©è¿›ï¼ˆæ¯è¡Œå‰åŠ ä¸¤ä¸ªç©ºæ ¼ï¼‰
            const indentedCode = code.split('\n').map(line => '  ' + line).join('\n');
            
            return header + '\n' + indentedCode;
        }
        
        // å¤åˆ¶ä»£ç 
        function copyCode() {
            const shareCode = generateTemplateShareCode();
            if (!shareCode) {
                alert('è¯·å…ˆç”Ÿæˆä»£ç ï¼');
                return;
            }
            navigator.clipboard.writeText(shareCode).then(() => {
                const customTitlePrefix = document.getElementById('customTitlePrefix').value.trim();
                const templateName = customTitlePrefix || 'Note with Meta Data';
                alert(`æ¨¡æ¿åˆ†äº«ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\næ¨¡æ¿åç§°: [item] ${templateName}\n\nè¯·åœ¨ Better Notes æ¨¡æ¿ç¼–è¾‘å™¨ä¸­:\né€‰é¡¹ > å¯¼å…¥ç¬”è®°æ¨¡æ¿: å‰ªè´´æ¿ä¸­çš„æ¨¡æ¿åˆ†äº«ä»£ç `);
            });
        }

        // ä¸‹è½½ä»£ç 
        function downloadCode() {
            const shareCode = generateTemplateShareCode();
            if (!shareCode) {
                alert('è¯·å…ˆç”Ÿæˆä»£ç ï¼');
                return;
            }
            
            const customTitlePrefix = document.getElementById('customTitlePrefix').value.trim();
            const templateName = customTitlePrefix || 'Note with Meta Data';
            const fileName = `[item] ${templateName}.txt`;
            
            const blob = new Blob([shareCode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        // åˆå§‹åŒ–
        // renderSections(); // åˆ é™¤è¿™è¡Œ,å› ä¸ºä¸éœ€è¦åˆå§‹åŒ–æ¸²æŸ“
    </script>

    <!-- ä½œè€…ä¿¡æ¯ -->
    <div class="author-info">
        <span class="author-name">ä½œè€…: Stream-L</span>
        <span class="separator">|</span>
        <a href="https://stream-l.github.io/" target="_blank" rel="noopener">åšå®¢</a>
    </div>
</body>
</html>
