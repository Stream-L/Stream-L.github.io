
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zotero笔记模板生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #F2F2F2;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .panel {
            padding: 30px;
        }

        .config-panel {
            border-bottom: 2px solid #F2F2F2;
        }

        .code-panel {
            background: #FAFAFA;
            max-height: 600px;
            overflow-y: auto;
        }

        h1 {
            color: #222222;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #9C9C9C;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .author-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 12px;
            color: #9C9C9C;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .author-info:hover {
            opacity: 1;
        }

        .author-info .author-name {
            color: #9C9C9C;
            font-weight: normal;
        }

        .author-info .separator {
            color: #9C9C9C;
        }

        .author-info a {
            color: #9C9C9C;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .author-info a:hover {
            color: #0069E0;
        }

        .section {
            background: #FAFAFA;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #E8E8E8;
        }

        .config-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .config-sections {
                grid-template-columns: 1fr;
            }
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #222222;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333333;
            font-size: 14px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="color"],
        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #E8E8E8;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
            color: #222222;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #0069E0;
        }

        input[type="color"] {
            height: 40px;
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #E8E8E8;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #333333;
        }
        
        .radio-item input[type="radio"]:disabled + label {
            color: #999999;
            cursor: not-allowed;
        }

        input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        input[type="radio"]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .metadata-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            max-height: 250px;
            overflow-y: auto;
        }

        .section-list {
            margin-top: 15px;
        }

        .section-card {
            background: white;
            border: 2px solid #0069E0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .section-card-header {
            display: grid;
            grid-template-columns: 1fr 150px 80px;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #F2F2F2;
        }

        .section-card-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .section-card-label {
            font-size: 12px;
            color: #9C9C9C;
            font-weight: 500;
        }

        .section-card-title {
            font-weight: 600;
            color: #222222;
            font-size: 15px;
        }

        .subsection-list {
            margin-top: 10px;
        }

        .subsection-header {
            display: grid;
            grid-template-columns: 200px 1fr 40px;
            gap: 10px;
            padding: 8px 10px;
            background: #f0f0f0;
            font-weight: 600;
            color: #555;
            border-radius: 4px;
            font-size: 13px;
        }

        .subsection-item {
            display: grid;
            grid-template-columns: 200px 1fr 40px;
            gap: 10px;
            padding: 8px 10px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-top: none;
            align-items: center;
        }

        .subsection-item:last-child {
            border-radius: 0 0 4px 4px;
        }

        .subsection-item input[type="text"] {
            padding: 6px 10px;
            font-size: 13px;
        }

        .btn-remove {
            background: #DB2C3A;
            color: white;
            border: none;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            width: 32px;
            height: 32px;
        }

        .btn-remove:hover {
            background: #C02030;
        }

        .btn-add-sub {
            background: #0069E0;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
        }

        .btn-add-sub:hover {
            background: #0055B8;
        }

        .btn-add {
            background: #0069E0;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }

        .btn-add:hover {
            background: #0055B8;
        }

        .btn-import {
            background: #6D6D6D;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            margin-left: 10px;
            font-size: 14px;
        }

        .btn-import:hover {
            background: #555555;
        }

        .old-section-item {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #0069E0;
            color: white;
        }

        .btn-primary:hover {
            background: #0055B8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 105, 224, 0.3);
        }

        .btn-secondary {
            background: #F5F5F5;
            color: #333;
            border: 1px solid #E0E0E0;
        }

        .btn-secondary:hover {
            background: #E8E8E8;
            border-color: #CCCCCC;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background: #DB2C3A;
            color: white;
        }

        .btn-danger:hover {
            background: #C02030;
        }

        .checkbox-group {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 20px;
            margin-bottom: 12px;
            min-width: 150px;
        }
        
        .metadata-fields {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .fields-section {
            margin-bottom: 16px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 15px;
            background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
            border: 1px solid #DEE2E6;
            border-radius: 6px;
            margin-bottom: 12px;
            user-select: none;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .section-header:hover {
            background: linear-gradient(135deg, #E9ECEF 0%, #DEE2E6 100%);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .section-header .arrow {
            transition: transform 0.3s;
            font-size: 16px;
            color: #495057;
            font-weight: bold;
        }
        
        .section-header .arrow.collapsed {
            transform: rotate(-90deg);
        }
        
        .section-header .title {
            font-weight: 600;
            color: #212529;
            font-size: 14px;
        }
        
        .section-header .count {
            color: #6C757D;
            font-size: 13px;
            margin-left: auto;
            background: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .collapsible-content {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
        }
        
        .collapsible-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin: 0;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .color-picker-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-preview {
            display: none; /* 隐藏预览框，直接使用color picker */
        }

        input[type="color"] {
            width: 60px;
            height: 35px;
            border: 1px solid #E8E8E8;
            border-radius: 4px;
            cursor: pointer;
            padding: 2px;
        }
        
        .section-item {
            background: white;
            border: 1px solid #E8E8E8;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .section-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .sub-item {
            background: #FAFAFA;
            border-left: 3px solid #0069E0;
            padding: 10px;
            margin: 8px 0 8px 20px;
            border-radius: 4px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .code-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .drag-handle {
            cursor: move;
            color: #9C9C9C;
            margin-right: 10px;
        }

        .emoji-picker {
            width: 60px;
        }

        small {
            color: #9C9C9C;
            font-size: 12px;
        }

        .help-btn {
            display: inline-block;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            background: #6D6D6D;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            margin-left: 8px;
            position: relative;
        }

        .help-btn:hover {
            background: #555555;
        }

        .help-btn .tooltip {
            visibility: hidden;
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: #222222;
            color: white;
            padding: 12px 15px;
            border-radius: 6px;
            white-space: pre-line;
            font-size: 13px;
            line-height: 1.6;
            z-index: 1000;
            min-width: 350px;
            max-width: 450px;
            text-align: left;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .help-btn:hover .tooltip {
            visibility: visible;
        }

        .help-btn .tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: #222222;
        }

        .preview-hint {
            background: #FFF9E6;
            border: 1px solid #FFE5A0;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #6D6D6D;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 左侧配置面板 -->
        <div class="panel config-panel">
            <h1>📝 Zotero笔记模板生成器
                <span class="help-btn">?
                    <span class="tooltip">📖 笔记模板添加方式：
1. 安装Better Notes 插件
2. 打开模板编辑器
   Zotero > 编辑 > 设置 > Better Notes
   向下滚动，在模板部分点击"打开模板编辑器"按钮
3. 新建模板：左下角"新建"模板
   选择新建的模板（最下面，红色，名称为 New Template:……）
4. 设置模板：模板类型选为条目，模板名称自定义
   将当前生成器生成的代码粘贴到模板编辑器中
   点击左下角的保存即可刷新预览</span>
                </span>
            </h1>
            <p class="subtitle">可视化配置Better Notes模板</p>

            <!-- 标题设置 -->
            <div class="section" style="margin-bottom: 20px;">
                <div class="section-title">🏷️ 笔记标题设置</div>
                
                <div class="form-group">
                    <label>自定义标题前缀 (可留空)</label>
                    <input type="text" id="customTitlePrefix" placeholder="例如: 【阅读笔记】、Reading Notes: 等">
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="appendOriginalTitle" checked>
                    <label for="appendOriginalTitle">在自定义标题后追加原文标题</label>
                </div>
                
                <small style="color: #999; display: block; margin-top: 8px;">
                    💡 如果不填写自定义标题且不勾选追加,将只显示原文标题
                </small>
            </div>

            <!-- 元数据模块 -->
            <div class="section">
                <div class="section-title">💡 元数据模块</div>
                
                <div class="form-row-3">
                    <div class="form-group">
                        <label>语言</label>
                        <select id="metaLang">
                            <option value="zh">中文</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>颜色1</label>
                        <div class="color-picker-wrapper">
                            <input type="color" id="metaColor1" value="#dbeedd">
                            <input type="text" id="metaColorText1" value="#dbeedd" style="width: 90px;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>颜色2</label>
                        <div class="color-picker-wrapper">
                            <input type="color" id="metaColor2" value="#f3faf4">
                            <input type="text" id="metaColorText2" value="#f3faf4" style="width: 90px;">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>可选元数据字段 (勾选后仅在存在时显示)</label>
                    <div style="margin-bottom: 12px;">
                        <button type="button" class="btn-secondary" onclick="selectCommonFields()">快选：常用字段</button>
                        <button type="button" class="btn-secondary" onclick="selectAllFields()">全选</button>
                        <button type="button" class="btn-secondary" onclick="deselectAllFields()">全不选</button>
                    </div>
                    
                    <div id="metadataFields" style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- 常用字段 (不折叠) -->
                        <div>
                            <h4 style="color: #1B5E20; margin-bottom: 12px; font-size: 14px;">常用字段</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_title" checked>
                                    <label for="field_title">标题</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_creators" checked>
                                    <label for="field_creators">作者</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_date" checked>
                                    <label for="field_date">日期</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_publicationTitle" checked>
                                    <label for="field_publicationTitle">期刊（带标签）</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_doi" checked>
                                    <label for="field_doi">DOI</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_attachmentLink" checked>
                                    <label for="field_attachmentLink">附件（带链接）</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_abstract">
                                    <label for="field_abstract">摘要</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_year">
                                    <label for="field_year">年份</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_language">
                                    <label for="field_language">语言</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_itemType">
                                    <label for="field_itemType">文献类型</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_url">
                                    <label for="field_url">URL</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_pages">
                                    <label for="field_pages">页码</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_volume">
                                    <label for="field_volume">卷</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_issue">
                                    <label for="field_issue">期号</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_tags">
                                    <label for="field_tags">标签</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_extra">
                                    <label for="field_extra">附加信息</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_titleTranslation" onchange="toggleTitleTranslationOptions()">
                                    <label for="field_titleTranslation">标题翻译</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_abstractTranslation" onchange="toggleAbstractTranslationOptions()">
                                    <label for="field_abstractTranslation">摘要翻译</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 其他字段 (可折叠) -->
                        <div>
                            <div class="section-header" onclick="toggleOtherFields()">
                                <span id="otherFieldsToggleIcon" class="arrow">▼</span>
                                <span class="title">其他字段</span>
                                <span class="count">展开查看更多</span>
                            </div>
                        </div>
                        
                        <div id="otherFieldsContainer" style="display: none; padding: 15px; background: #F8F9FA; border: 1px solid #DEE2E6; border-radius: 6px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_isbn">
                                    <label for="field_isbn">ISBN</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_issn">
                                    <label for="field_issn">ISSN</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_accessDate">
                                    <label for="field_accessDate">访问日期</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_libraryCatalog">
                                    <label for="field_libraryCatalog">文库编目</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_shortTitle">
                                    <label for="field_shortTitle">短标题</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_journalAbbreviation">
                                    <label for="field_journalAbbreviation">期刊缩写</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_publisher">
                                    <label for="field_publisher">出版社</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_place">
                                    <label for="field_place">出版地</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_edition">
                                    <label for="field_edition">版本</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_series">
                                    <label for="field_series">系列</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_seriesNumber">
                                    <label for="field_seriesNumber">系列编号</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_bookTitle">
                                    <label for="field_bookTitle">图书标题</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_conferenceName">
                                    <label for="field_conferenceName">会议名称</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_university">
                                    <label for="field_university">大学</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_thesisType">
                                    <label for="field_thesisType">学位类型</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_reportType">
                                    <label for="field_reportType">报告类型</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_reportNumber">
                                    <label for="field_reportNumber">报告编号</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_archive">
                                    <label for="field_archive">档案</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_archiveLocation">
                                    <label for="field_archiveLocation">档案位置</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_callNumber">
                                    <label for="field_callNumber">索书号</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_rights">
                                    <label for="field_rights">权利</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_key">
                                    <label for="field_key">项目键</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_id">
                                    <label for="field_id">项目ID</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_libraryID">
                                    <label for="field_libraryID">图书馆ID</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_dateAdded">
                                    <label for="field_dateAdded">添加日期</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_dateModified">
                                    <label for="field_dateModified">修改日期</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_attachmentCount">
                                    <label for="field_attachmentCount">附件数量</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_attachmentName">
                                    <label for="field_attachmentName">附件名称</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="field_noteCount">
                                    <label for="field_noteCount">子笔记数量</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>标题翻译显示方式 <span style="color: #999; font-size: 12px;">(需先勾选"标题翻译"字段)</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="titleOption1" name="titleTranslation" value="show" checked disabled>
                            <label for="titleOption1">单独显示翻译</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="titleOption2" name="titleTranslation" value="replace" disabled>
                            <label for="titleOption2">覆盖原文</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>摘要翻译显示方式 <span style="color: #999; font-size: 12px;">(需先勾选"摘要翻译"字段)</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="abstractOption1" name="abstractTranslation" value="show" checked disabled>
                            <label for="abstractOption1">单独显示翻译</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="abstractOption2" name="abstractTranslation" value="replace" disabled>
                            <label for="abstractOption2">覆盖原文</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>日期与作者显示方式</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="dateAuthorsOption1" name="dateAuthorsDisplay" value="merged" checked>
                            <label for="dateAuthorsOption1">合并显示</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="dateAuthorsOption2" name="dateAuthorsDisplay" value="separate">
                            <label for="dateAuthorsOption2">分开显示</label>
                        </div>
                    </div>
                    <small style="color: #999; display: block; margin-top: 5px;">
                        💡 合并显示: 2023 - John Smith; Jane Doe (节省空间)
                    </small>
                </div>
            </div>

            <!-- 笔记章节 -->
            <div class="section">
                <div class="section-title">📒 笔记章节
                    <span class="help-btn">?
                        <span class="tooltip">📋 从剪贴板导入章节的格式：

1. 如有Style且设置了标注颜色可以使用
2. 打开标注颜色管理：有两种方式
   ① Shift+P > 标注
   ② Zotero > 编辑 > 设置 > Style
      向下滚动 阅读界面 > 标注颜色 > 编辑
3. 导出颜色组：在左侧选择Group
   确定后点击右上角的Export
   将标注名和颜色复制到粘贴板中
4. 导入模板编辑器：点击导入
   原标注名会识别为章节名称
   颜色会识别为章节标题的底色

支持格式：[["标题","#颜色"]]</span>
                    </span>
                </div>
                
                <div class="section-list">

                    <div id="noteSections"></div>
                </div>
                
                <div style="margin-top: 10px;">
                    <button class="btn-add" onclick="addSection()">➕ 添加章节</button>
                    <button class="btn-import" onclick="importFromClipboard()">📋 从剪贴板导入</button>
                </div>
            </div>
        </div>

        <!-- 右侧预览/代码面板 -->
        <div class="panel code-panel">
            <div class="preview-hint">
                💡 提示：使用 <code>$</code> 表示的内容导入Better Notes后会被替换，请忽略
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generateCode()">🔄 生成代码</button>
                <button class="btn btn-secondary" onclick="previewTemplate()">👁️ 预览效果</button>
                <button class="btn btn-secondary" onclick="copyCode()">📋 复制代码</button>
                <button class="btn btn-secondary" onclick="downloadCode()">💾 下载模板</button>
            </div>
            <div class="code-output" id="codeOutput">点击"生成代码"按钮来生成模板代码...</div>
        </div>
    </div>

    <script>
        // 字段快捷选择函数
        function selectCommonFields() {
            // 常用字段默认选择：标题、作者、日期、期刊、DOI、附件
            const commonFields = ['title', 'creators', 'date', 'publicationTitle', 'doi', 'attachmentLink'];
            const allCheckboxes = document.querySelectorAll('#metadataFields input[type="checkbox"]');
            
            allCheckboxes.forEach(cb => {
                const fieldName = cb.id.replace('field_', '');
                cb.checked = commonFields.includes(fieldName);
            });
        }
        
        function selectAllFields() {
            const allCheckboxes = document.querySelectorAll('#metadataFields input[type="checkbox"]');
            allCheckboxes.forEach(cb => cb.checked = true);
            // 触发翻译选项的显示
            toggleTitleTranslationOptions();
            toggleAbstractTranslationOptions();
        }
        
        function deselectAllFields() {
            const allCheckboxes = document.querySelectorAll('#metadataFields input[type="checkbox"]');
            allCheckboxes.forEach(cb => cb.checked = false);
            // 触发翻译选项的禁用
            toggleTitleTranslationOptions();
            toggleAbstractTranslationOptions();
        }
        
        // 折叠/展开其他字段
        function toggleOtherFields() {
            const container = document.getElementById('otherFieldsContainer');
            const icon = document.getElementById('otherFieldsToggleIcon');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.textContent = '▼';
                icon.classList.remove('collapsed');
            } else {
                container.style.display = 'none';
                icon.textContent = '▶';
                icon.classList.add('collapsed');
            }
        }
        
        // 启用/禁用标题翻译选项
        function toggleTitleTranslationOptions() {
            const checkbox = document.getElementById('field_titleTranslation');
            const option1 = document.getElementById('titleOption1');
            const option2 = document.getElementById('titleOption2');
            
            option1.disabled = !checkbox.checked;
            option2.disabled = !checkbox.checked;
        }
        
        // 启用/禁用摘要翻译选项
        function toggleAbstractTranslationOptions() {
            const checkbox = document.getElementById('field_abstractTranslation');
            const option1 = document.getElementById('abstractOption1');
            const option2 = document.getElementById('abstractOption2');
            
            option1.disabled = !checkbox.checked;
            option2.disabled = !checkbox.checked;
        }
    
        // 颜色选择器同步
        function setupColorPicker(colorId, textId) {
            const colorInput = document.getElementById(colorId);
            const textInput = document.getElementById(textId);

            colorInput.addEventListener('input', (e) => {
                textInput.value = e.target.value;
            });

            textInput.addEventListener('input', (e) => {
                if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                    colorInput.value = e.target.value;
                }
            });
        }

        setupColorPicker('metaColor1', 'metaColorText1');
        setupColorPicker('metaColor2', 'metaColorText2');

        // 章节管理
        let sectionCount = 0;
        let sections = {}; // 存储所有章节数据

        // 添加章节
        function addSection(title = '核心贡献', bgColor = '#FFEB3B') {
            sectionCount++;
            const sectionId = sectionCount;
            
            sections[sectionId] = {
                title: title,
                bgColor: bgColor,
                subsections: []
            };
            
            renderSections();
        }

        // 添加子章节
        function addSubsection(sectionId) {
            if (!sections[sectionId].subsections) {
                sections[sectionId].subsections = [];
            }
            sections[sectionId].subsections.push({
                title: '',
                prompt: ''
            });
            renderSections();
        }

        // 删除章节
        function deleteSection(sectionId) {
            delete sections[sectionId];
            renderSections();
        }

        // 删除子章节
        function deleteSubsection(sectionId, subIndex) {
            sections[sectionId].subsections.splice(subIndex, 1);
            renderSections();
        }

        // 更新章节标题
        function updateSectionTitle(sectionId, value) {
            if (sections[sectionId]) {
                sections[sectionId].title = value;
            }
        }

        // 更新章节颜色
        function updateSectionColor(sectionId, value) {
            if (sections[sectionId]) {
                sections[sectionId].bgColor = value;
            }
        }

        // 更新子章节
        function updateSubsection(sectionId, subIndex, field, value) {
            if (sections[sectionId] && sections[sectionId].subsections[subIndex]) {
                sections[sectionId].subsections[subIndex][field] = value;
            }
        }

        // 渲染所有章节
        function renderSections() {
            const container = document.getElementById('noteSections');
            container.innerHTML = '';
            
            Object.keys(sections).forEach(sectionId => {
                const section = sections[sectionId];
                const card = document.createElement('div');
                card.className = 'section-card';
                
                let subsectionsHtml = '';
                if (section.subsections && section.subsections.length > 0) {
                    subsectionsHtml = `
                        <div class="subsection-list">
                            <div class="subsection-header">
                                <div>子章节标题</div>
                                <div>子章节提示</div>
                                <div>操作</div>
                            </div>
                            ${section.subsections.map((sub, subIndex) => `
                                <div class="subsection-item">
                                    <input type="text" 
                                           value="${sub.title || ''}" 
                                           placeholder="例如: 研究方法"
                                           onchange="updateSubsection(${sectionId}, ${subIndex}, 'title', this.value)">
                                    <input type="text" 
                                           value="${sub.prompt || ''}" 
                                           placeholder="例如: 作者使用了什么研究方法？"
                                           onchange="updateSubsection(${sectionId}, ${subIndex}, 'prompt', this.value)">
                                    <button class="btn-remove" 
                                            onclick="deleteSubsection(${sectionId}, ${subIndex})" 
                                            title="删除">✕</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <div class="section-card-header">
                        <div class="section-card-field">
                            <label class="section-card-label">章节标题</label>
                            <input type="text" 
                                   class="section-card-title"
                                   value="${section.title}" 
                                   placeholder="例如: 核心贡献"
                                   onchange="updateSectionTitle(${sectionId}, this.value)">
                        </div>
                        <div class="section-card-field">
                            <label class="section-card-label">背景色</label>
                            <div class="color-picker-wrapper">
                                <input type="color" 
                                       id="sectionColor${sectionId}" 
                                       value="${section.bgColor}"
                                       onchange="updateSectionColor(${sectionId}, this.value); document.getElementById('sectionColorText${sectionId}').value = this.value;">
                                <input type="text" 
                                       id="sectionColorText${sectionId}" 
                                       value="${section.bgColor}" 
                                       style="width: 70px;"
                                       onchange="updateSectionColor(${sectionId}, this.value); document.getElementById('sectionColor${sectionId}').value = this.value;">
                            </div>
                        </div>
                        <button class="btn-remove" onclick="deleteSection(${sectionId})" title="删除章节" style="margin-top: 20px;">✕</button>
                    </div>
                    ${subsectionsHtml}
                    <button class="btn-add-sub" onclick="addSubsection(${sectionId})">➕ 添加子章节</button>
                `;
                
                container.appendChild(card);
            });
        }

        // 从剪贴板导入章节
        async function importFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                // 尝试解析JSON数组: [["核心贡献","#FFEB3B"],["算法核心","#42A5F5"],...]
                const importData = JSON.parse(text);
                
                if (!Array.isArray(importData)) {
                    throw new Error('剪贴板内容不是数组格式');
                }
                
                // 清空现有章节
                sections = {};
                sectionCount = 0;
                
                // 添加导入的章节
                importData.forEach(([title, color]) => {
                    if (title && color) {
                        addSection(title, color);
                    }
                });
                
                alert(`成功导入 ${importData.length} 个章节！`);
            } catch (error) {
                alert(`导入失败：${error.message}\n\n请确保剪贴板内容格式为：\n[["标题1","#颜色1"],["标题2","#颜色2"]]`);
            }
        }

        // 生成代码
        // 字段配置映射
        const FIELD_CONFIG = {
            // 通用字段
            title: { zoteroField: 'title', labelZh: '标题', labelEn: 'Title' },
            creators: { zoteroField: 'creators', labelZh: '作者', labelEn: 'Authors', isComplex: true },
            date: { zoteroField: 'date', labelZh: '日期', labelEn: 'Date' },
            year: { zoteroField: 'date', labelZh: '年份', labelEn: 'Year', transform: (val) => val?.substring(0,4) },
            itemType: { zoteroField: 'itemType', labelZh: '文献类型', labelEn: 'Type', isComplex: true },
            extra: { zoteroField: 'extra', labelZh: '附加信息', labelEn: 'Extra' },
            tags: { zoteroField: 'tags', labelZh: '标签', labelEn: 'Tags', isComplex: true },
            
            // 常用字段
            abstract: { zoteroField: 'abstractNote', labelZh: '摘要', labelEn: 'Abstract' },
            publicationTitle: { zoteroField: 'publicationTitle', labelZh: '期刊/出版物', labelEn: 'Publication' },
            language: { zoteroField: 'language', labelZh: '语言', labelEn: 'Language' },
            url: { zoteroField: 'url', labelZh: 'URL', labelEn: 'URL' },
            accessDate: { zoteroField: 'accessDate', labelZh: '访问日期', labelEn: 'Access Date' },
            libraryCatalog: { zoteroField: 'libraryCatalog', labelZh: '文库编目', labelEn: 'Library Catalog' },
            
            // 页码和卷期
            pages: { zoteroField: 'pages', labelZh: '页码', labelEn: 'Pages' },
            volume: { zoteroField: 'volume', labelZh: '卷', labelEn: 'Volume' },
            issue: { zoteroField: 'issue', labelZh: '期号', labelEn: 'Issue' },
            
            // 出版信息
            publisher: { zoteroField: 'publisher', labelZh: '出版社', labelEn: 'Publisher' },
            place: { zoteroField: 'place', labelZh: '出版地', labelEn: 'Place' },
            edition: { zoteroField: 'edition', labelZh: '版本', labelEn: 'Edition' },
            
            // 标题相关
            shortTitle: { zoteroField: 'shortTitle', labelZh: '短标题', labelEn: 'Short Title' },
            
            // 系列
            series: { zoteroField: 'series', labelZh: '系列', labelEn: 'Series' },
            seriesNumber: { zoteroField: 'seriesNumber', labelZh: '系列编号', labelEn: 'Series Number' },
            
            // 特定类型
            bookTitle: { zoteroField: 'bookTitle', labelZh: '图书标题', labelEn: 'Book Title' },
            conferenceName: { zoteroField: 'conferenceName', labelZh: '会议名称', labelEn: 'Conference' },
            university: { zoteroField: 'university', labelZh: '大学', labelEn: 'University' },
            thesisType: { zoteroField: 'thesisType', labelZh: '学位类型', labelEn: 'Thesis Type' },
            reportType: { zoteroField: 'reportType', labelZh: '报告类型', labelEn: 'Report Type' },
            reportNumber: { zoteroField: 'reportNumber', labelZh: '报告编号', labelEn: 'Report Number' },
            
            // 期刊相关
            journalAbbreviation: { zoteroField: 'journalAbbreviation', labelZh: '期刊缩写', labelEn: 'Journal Abbr.' },
            
            // 档案
            archive: { zoteroField: 'archive', labelZh: '档案', labelEn: 'Archive' },
            archiveLocation: { zoteroField: 'archiveLocation', labelZh: '档案位置', labelEn: 'Archive Location' },
            callNumber: { zoteroField: 'callNumber', labelZh: '索书号', labelEn: 'Call Number' },
            rights: { zoteroField: 'rights', labelZh: '权利', labelEn: 'Rights' },
            
            // 系统字段
            key: { zoteroField: 'key', labelZh: '项目键', labelEn: 'Key' },
            id: { zoteroField: 'id', labelZh: '项目ID', labelEn: 'ID', isComplex: true },
            libraryID: { zoteroField: 'libraryID', labelZh: '图书馆ID', labelEn: 'Library ID', isComplex: true },
            dateAdded: { zoteroField: 'dateAdded', labelZh: '添加日期', labelEn: 'Date Added' },
            dateModified: { zoteroField: 'dateModified', labelZh: '修改日期', labelEn: 'Date Modified' }
        };
    
        function generateCode() {
            const lang = document.getElementById('metaLang').value;
            const color1 = document.getElementById('metaColorText1').value;
            const color2 = document.getElementById('metaColorText2').value;
            
            const customTitlePrefix = document.getElementById('customTitlePrefix').value.trim();
            const appendOriginalTitle = document.getElementById('appendOriginalTitle').checked;
            
            // 只有勾选了翻译字段才读取翻译选项
            const titleTranslationChecked = document.getElementById('field_titleTranslation').checked;
            const titleTranslationOption = titleTranslationChecked ? document.querySelector('input[name="titleTranslation"]:checked').value : 'none';
            
            const abstractTranslationChecked = document.getElementById('field_abstractTranslation').checked;
            const abstractTranslationOption = abstractTranslationChecked ? document.querySelector('input[name="abstractTranslation"]:checked').value : 'none';
            
            const dateAuthorsDisplay = document.querySelector('input[name="dateAuthorsDisplay"]:checked').value;
            
            const langText = {
                zh: {
                    metaTitle: '元数据',
                    title: '标题',
                    titleTranslation: '标题翻译',
                    journal: '期刊',
                    dateAuthors: '日期与作者',
                    language: '语言',
                    itemType: '文献类型',
                    doi: 'DOI',
                    url: '链接',
                    pages: '页码',
                    volume: '卷期',
                    attachment: '附件',
                    abstract: '摘要',
                    abstractTranslation: '摘要翻译'
                },
                en: {
                    metaTitle: 'Metadata',
                    title: 'Title',
                    titleTranslation: 'Title Translation',
                    journal: 'Journal (with tags)',
                    dateAuthors: 'Date & Authors',
                    language: 'Language',
                    itemType: 'Item Type',
                    doi: 'DOI',
                    url: 'URL',
                    pages: 'Pages',
                    volume: 'Volume/Issue',
                    attachment: 'Attachment',
                    abstract: 'Abstract',
                    abstractTranslation: 'Abstract Translation'
                }
            };

            const t = langText[lang];
            
            // 生成标题逻辑
            let titleCode = '';
            if (customTitlePrefix && appendOriginalTitle) {
                // 有前缀且追加原标题 (中间加空格)
                titleCode = `<h1 style="text-align: center">${customTitlePrefix} \${topItem.getField('title') || '无标题'}</h1>\n`;
            } else if (customTitlePrefix && !appendOriginalTitle) {
                // 只有前缀,不追加原标题
                titleCode = `<h1 style="text-align: center">${customTitlePrefix}</h1>\n`;
            } else {
                // 没有前缀,显示原标题
                titleCode = `<h1 style="text-align: center">\${topItem.getField('title') || '无标题'}</h1>\n`;
            }
            
            let code = titleCode;
            code += `<hr/>\n`;
            code += `<h2 style="color: #1B5E20; background-color:#F1F8E9;">💡 ${t.metaTitle}</h2>\n\n`;
            code += `<table>\n`;
            
            // 可选字段: 标题
            let useColor = color1;
            
            if (document.getElementById('field_title').checked) {
                const replaceTitleWithTranslation = titleTranslationOption === 'replace';
                const showTitleTranslation = titleTranslationOption === 'show';
                
                if (replaceTitleWithTranslation) {
                    code += `    <tr>\n        <th style="background-color:${useColor}; text-align: left;">${t.title}</th>\n`;
                    code += `        <td style="background-color:${useColor};">\${{
            try {
                const titleTranslation = Zotero.PDFTranslate?.data?.ztoolkit?.ExtraField?.getExtraField(topItem, "titleTranslation");
                return titleTranslation && titleTranslation.trim() ? titleTranslation : topItem.getField('title');
            } catch (e) {
                return topItem.getField('title');
            }
        }}\$</td>\n    </tr>\n`;
                } else {
                    code += `    <tr>\n        <th style="background-color:${useColor}; text-align: left;">${t.title}</th>\n`;
                    code += `        <td style="background-color:${useColor};">\${topItem.getField('title') || '无标题'}</td>\n    </tr>\n`;
                    useColor = useColor === color1 ? color2 : color1;
                    
                    if (showTitleTranslation) {
                        code += `    \${{
        try {
            const titleTranslation = Zotero.PDFTranslate?.data?.ztoolkit?.ExtraField?.getExtraField(topItem, "titleTranslation");
            if (titleTranslation && titleTranslation.trim()) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.titleTranslation}</th>
                    <td style="background-color:${useColor}; font-style: italic;">\${titleTranslation}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                        useColor = useColor === color1 ? color2 : color1;
                    }
                }
            } else {
                useColor = useColor === color1 ? color2 : color1;
            }

            // 可选字段: 期刊 (可选显示，没有则不显示)
            if (document.getElementById('field_publicationTitle') && document.getElementById('field_publicationTitle').checked) {
                code += `    \${{
        try {
            const publicationTitle = topItem.getField('publicationTitle');
            if (publicationTitle) {
                let tagsHtml = '';
                try {
                    const nodes = Zotero.ZoteroStyle.api.renderCell(topItem, "publicationTags").childNodes;
                    if (nodes && nodes.length) {
                        tagsHtml = ' ' + Array.prototype.map.call(nodes, e => {
                            e.style.marginLeft = '4px';
                            e.style.marginRight = '4px';
                            return e.outerHTML;
                        }).join(' ');
                    }
                } catch (e) {}
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.journal}</th>
                    <td style="background-color:${useColor};">\${publicationTitle}\${tagsHtml}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            // 可选字段: 日期与作者
            const dateChecked = document.getElementById('field_date').checked;
            const authorsChecked = document.getElementById('field_creators') && document.getElementById('field_creators').checked;
            
            if (dateAuthorsDisplay === 'merged' && (dateChecked || authorsChecked)) {
                // 合并显示模式
                code += `    <tr>\n        <th style="background-color:${useColor}; text-align: left;">${t.dateAuthors}</th>\n`;
                code += `        <td style="background-color:${useColor};">\${topItem.getField('date')?.substring(0,4) || '无年份'} - 
            \${topItem.getCreators()?.length 
                ? topItem.getCreators().map(v => \`\${v.firstName || ''} \${v.lastName || ''}\`).join("; ").trim() 
                : '无作者信息'}</td>\n    </tr>\n`;
                useColor = useColor === color1 ? color2 : color1;
            } else {
                // 分开显示模式
                if (dateChecked) {
                    code += `    <tr>\n        <th style="background-color:${useColor}; text-align: left;">日期</th>\n`;
                    code += `        <td style="background-color:${useColor};">\${topItem.getField('date')?.substring(0,4) || '无年份'}</td>\n    </tr>\n`;
                    useColor = useColor === color1 ? color2 : color1;
                }
                
                if (authorsChecked) {
                    code += `    <tr>\n        <th style="background-color:${useColor}; text-align: left;">作者</th>\n`;
                    code += `        <td style="background-color:${useColor};">\${topItem.getCreators()?.length 
                ? topItem.getCreators().map(v => \`\${v.firstName || ''} \${v.lastName || ''}\`).join("; ").trim() 
                : '无作者信息'}</td>\n    </tr>\n`;
                    useColor = useColor === color1 ? color2 : color1;
                }
            }
            
            // 其他可选字段
            
            if (document.getElementById('field_language').checked) {
                code += `    \${{
        try {
            const language = topItem.getField('language');
            if (language) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.language}</th>
                    <td style="background-color:${useColor};">\${language}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            if (document.getElementById('field_itemType').checked) {
                code += `    \${{
        try {
            const itemType = topItem.itemType;
            if (itemType) {
                const typeNames = {
                    'journalArticle': '期刊论文',
                    'conferencePaper': '会议论文',
                    'book': '书籍',
                    'bookSection': '书籍章节',
                    'thesis': '学位论文',
                    'report': '报告'
                };
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.itemType}</th>
                    <td style="background-color:${useColor};">\${typeNames[itemType] || itemType}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            if (document.getElementById('field_doi').checked) {
                code += `    \${topItem.getField('DOI') ? \`
    <tr>
        <th style="background-color:${useColor}; text-align: left;">${t.doi}</th>
        <td style="background-color:${useColor};">
            <a href="https://doi.org/\${topItem.getField('DOI')}">\${topItem.getField('DOI')}</a>
        </td>
    </tr>
    \` : ''}\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            if (document.getElementById('field_url').checked) {
                code += `    \${{
        try {
            const url = topItem.getField('url');
            if (url) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.url}</th>
                    <td style="background-color:${useColor};">
                        <a href="\${url}">\${url.length > 50 ? url.substring(0, 47) + '...' : url}</a>
                    </td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            if (document.getElementById('field_pages').checked) {
                code += `    \${{
        try {
            const pages = topItem.getField('pages');
            if (pages) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.pages}</th>
                    <td style="background-color:${useColor};">\${pages}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            if (document.getElementById('field_volume').checked) {
                code += `    \${{
        try {
            const volume = topItem.getField('volume');
            const issue = topItem.getField('issue');
            if (volume || issue) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.volume}</th>
                    <td style="background-color:${useColor};">
                        \${volume ? \`Vol. \${volume}\` : ''}\${volume && issue ? ', ' : ''}\${issue ? \`No. \${issue}\` : ''}
                    </td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            if (document.getElementById('field_attachmentLink') && document.getElementById('field_attachmentLink').checked) {
                code += `    \${(() => {
        try {
            const attachments = topItem.getAttachments();
            if (attachments && attachments.length) {
                const attachment = Zotero.Items.get(attachments[0]);
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${t.attachment}</th>
                    <td style="background-color:${useColor};">
                        <a href="zotero://open-pdf/0_\${attachment.key}">\${attachment.getFilename() || '附件'}</a>
                    </td>
                </tr>
                \`;
            }
            return '';
        } catch (e) {
            return '';
        }
    })()}\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            // 摘要
            const replaceAbstractWithTranslation = abstractTranslationOption === 'replace';
            const showAbstractTranslation = abstractTranslationOption === 'show';
            
            if (document.getElementById('field_abstract').checked) {
                if (replaceAbstractWithTranslation) {
                    code += `    \${{
        try {
            const abstractTranslation = Zotero.PDFTranslate?.data?.ztoolkit?.ExtraField?.getExtraField(topItem, "abstractTranslation");
            const abstract = topItem.getField('abstractNote');
            const content = abstractTranslation && abstractTranslation.trim() ? abstractTranslation : abstract;
            if (content && content.trim()) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left; vertical-align: top;">${t.abstract}</th>
                    <td style="background-color:${useColor}; text-align: justify; line-height: 1.6;">\${content}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                } else {
                    code += `    \${{
        try {
            const abstract = topItem.getField('abstractNote');
            if (abstract && abstract.trim()) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left; vertical-align: top;">${t.abstract}</th>
                    <td style="background-color:${useColor}; text-align: justify; line-height: 1.6;">\${abstract}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                    useColor = useColor === color1 ? color2 : color1;
                    
                    if (showAbstractTranslation) {
                        code += `    \${{
        try {
            const abstractTranslation = Zotero.PDFTranslate?.data?.ztoolkit?.ExtraField?.getExtraField(topItem, "abstractTranslation");
            if (abstractTranslation && abstractTranslation.trim()) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left; vertical-align: top;">${t.abstractTranslation}</th>
                    <td style="background-color:${useColor}; text-align: justify; line-height: 1.6; font-style: italic;">\${abstractTranslation}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                        useColor = useColor === color1 ? color2 : color1;
                    }
                }
            }
            
            // 处理其他通用字段 (titleTranslation 和 abstractTranslation 由标题/摘要字段的翻译选项处理)
            const simpleFields = [
                'shortTitle', 'year', 'volume', 'issue', 'publisher', 'place', 'edition',
                'series', 'seriesNumber', 'bookTitle', 'conferenceName',
                'university', 'thesisType', 'reportType', 'reportNumber',
                'journalAbbreviation', 'archive', 'archiveLocation', 
                'callNumber', 'rights', 'extra'
            ];
            
            simpleFields.forEach(fieldName => {
                const fieldId = 'field_' + fieldName;
                const checkbox = document.getElementById(fieldId);
                if (!checkbox || !checkbox.checked) return;
                
                const config = FIELD_CONFIG[fieldName];
                if (!config) return;
                
                const label = lang === 'zh' ? config.labelZh : config.labelEn;
                const zField = config.zoteroField;
                
                // 特殊处理翻译字段
                if (fieldName === 'titleTranslation' || fieldName === 'abstractTranslation') {
                    code += `    \${{
        try {
            const value = Zotero.PDFTranslate?.data?.ztoolkit?.ExtraField?.getExtraField(topItem, "${fieldName}");
            if (value && value.trim()) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${label}</th>
                    <td style="background-color:${useColor}; font-style: italic;">\${value}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                } else {
                    code += `    \${{
        try {
            const value = topItem.getField('${zField}');
            if (value) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${label}</th>
                    <td style="background-color:${useColor};">\${value}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                }
                useColor = useColor === color1 ? color2 : color1;
            });
            
            // DOI 和 ISBN ISSN 特殊处理
            if (document.getElementById('field_doi') && document.getElementById('field_doi').checked) {
                code += `    \${topItem.getField('DOI') ? \`
    <tr>
        <th style="background-color:${useColor}; text-align: left;">DOI</th>
        <td style="background-color:${useColor};">
            <a href="https://doi.org/\${topItem.getField('DOI')}">\${topItem.getField('DOI')}</a>
        </td>
    </tr>
    \` : ''}\n`;
                useColor = useColor === color1 ? color2 : color1;
            }
            
            if (document.getElementById('field_isbn') && document.getElementById('field_isbn').checked) {
                code += `    \${{
        try {
            const isbn = topItem.getField('ISBN');
            if (isbn) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">ISBN</th>
                    <td style="background-color:${useColor};">\${isbn}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }
            
            if (document.getElementById('field_issn') && document.getElementById('field_issn').checked) {
                code += `    \${{
        try {
            const issn = topItem.getField('ISSN');
            if (issn) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">ISSN</th>
                    <td style="background-color:${useColor};">\${issn}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }
            
            // 标签
            if (document.getElementById('field_tags') && document.getElementById('field_tags').checked) {
                code += `    \${{
        try {
            const tags = topItem.getTags();
            if (tags && tags.length > 0) {
                const tagStr = tags.map(t => t.tag).join(', ');
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">标签</th>
                    <td style="background-color:${useColor};">\${tagStr}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }
            
            // 系统字段
            const systemFields = ['key', 'id', 'libraryID', 'dateAdded', 'dateModified'];
            systemFields.forEach(fieldName => {
                const checkbox = document.getElementById('field_' + fieldName);
                if (!checkbox || !checkbox.checked) return;
                
                const config = FIELD_CONFIG[fieldName];
                const label = lang === 'zh' ? config.labelZh : config.labelEn;
                
                if (fieldName === 'id' || fieldName === 'libraryID') {
                    code += `    \${{
        try {
            const value = topItem.${fieldName};
            if (value !== undefined && value !== null) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${label}</th>
                    <td style="background-color:${useColor};">\${value}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                } else {
                    code += `    \${{
        try {
            const value = topItem.getField('${config.zoteroField}');
            if (value) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${label}</th>
                    <td style="background-color:${useColor};">\${value}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                }
                useColor = useColor === color1 ? color2 : color1;
            });
            
            // 附件相关字段
            const attachmentFields = [
                { id: 'attachmentCount', label: '附件数量', code: 'topItem.getAttachments().length' },
                { id: 'noteCount', label: '子笔记数量', code: 'topItem.getNotes().length' }
            ];
            
            attachmentFields.forEach(field => {
                const checkbox = document.getElementById('field_' + field.id);
                if (!checkbox || !checkbox.checked) return;
                
                code += `    \${{
        try {
            const value = ${field.code};
            if (value !== undefined) {
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">${field.label}</th>
                    <td style="background-color:${useColor};">\${value}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            });
            
            // 附件名称和链接
            if (document.getElementById('field_attachmentName') && document.getElementById('field_attachmentName').checked) {
                code += `    \${{
        try {
            const attachments = topItem.getAttachments();
            if (attachments && attachments.length) {
                const attachment = Zotero.Items.get(attachments[0]);
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">附件名称</th>
                    <td style="background-color:${useColor};">\${attachment.getFilename() || '无名称'}</td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }
            
            if (document.getElementById('field_attachmentLink') && document.getElementById('field_attachmentLink').checked) {
                code += `    \${{
        try {
            const attachments = topItem.getAttachments();
            if (attachments && attachments.length) {
                const attachment = Zotero.Items.get(attachments[0]);
                return \`
                <tr>
                    <th style="background-color:${useColor}; text-align: left;">附件链接</th>
                    <td style="background-color:${useColor};">
                        <a href="zotero://open-pdf/0_\${attachment.key}">\${attachment.getFilename() || '打开附件'}</a>
                    </td>
                </tr>\`;
            }
        } catch (e) {}
        return '';
    }}\$\n`;
                useColor = useColor === color1 ? color2 : color1;
            }

            code += `</table>\n\n`;

            // 生成章节
            Object.keys(sections).forEach(sectionId => {
                const section = sections[sectionId];
                code += `<h2 style="background: ${section.bgColor}; color: #000; padding: 10px 15px; border-radius: 4px; margin-top: 30px;">${section.title}</h2>\n`;
                
                if (section.subsections && section.subsections.length > 0) {
                    section.subsections.forEach(sub => {
                        if (sub.title) {
                            code += `<h3>${sub.title}`;
                            if (sub.prompt) {
                                code += `<span style="color: #999; font-style: italic; font-weight: normal; margin-left: 10px;">${sub.prompt}</span>`;
                            }
                            code += `</h3>\n`;
                        }
                    });
                } else {
                    code += `<p>在此填写内容...</p>\n`;
                }
                
                code += `\n`;
            });

            document.getElementById('codeOutput').textContent = code;
        }

        // 预览模板
        function previewTemplate() {
            const code = document.getElementById('codeOutput').textContent;
            if (code === '点击"生成代码"按钮来生成模板代码...') {
                alert('请先生成代码！');
                return;
            }
            
            // 创建预览HTML，包含样式
            const previewHTML = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模板预览</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e0e0e0;
        }
        th {
            font-weight: 600;
            width: 150px;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        h2 {
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 30px;
        }
        hr {
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 10px 0;
        }
        p {
            line-height: 1.8;
            margin: 10px 0;
        }
        a {
            color: #667eea;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    ${code}
</body>
</html>`;
            
            // 在新窗口中打开预览
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(previewHTML);
            previewWindow.document.close();
        }

        // 复制代码
        function copyCode() {
            const code = document.getElementById('codeOutput').textContent;
            if (code === '点击"生成代码"按钮来生成模板代码...') {
                alert('请先生成代码！');
                return;
            }
            navigator.clipboard.writeText(code).then(() => {
                alert('代码已复制到剪贴板！');
            });
        }

        // 下载代码
        function downloadCode() {
            const code = document.getElementById('codeOutput').textContent;
            if (code === '点击"生成代码"按钮来生成模板代码...') {
                alert('请先生成代码！');
                return;
            }
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'zotero-template.html';
            a.click();
            URL.revokeObjectURL(url);
        }

        // 初始化
        // renderSections(); // 删除这行,因为不需要初始化渲染
    </script>

    <!-- 作者信息 -->
    <div class="author-info">
        <span class="author-name">作者: Stream-L</span>
        <span class="separator">|</span>
        <a href="https://stream-l.github.io/" target="_blank" rel="noopener">博客</a>
    </div>
</body>
</html>
