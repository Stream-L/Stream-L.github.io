<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoteroæ–‡çŒ®çŸ©é˜µè„šæœ¬ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #F2F2F2;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .panel {
            padding: 30px;
        }

        .config-panel {
            border-bottom: 2px solid #F2F2F2;
        }

        .code-panel {
            background: #FAFAFA;
            max-height: 600px;
            overflow-y: auto;
        }

        h1 {
            color: #222222;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #9C9C9C;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .help-btn {
            position: relative;
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #0069E0;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: help;
            margin-left: 8px;
        }

        .help-btn:hover .tooltip {
            display: block;
        }

        .tooltip {
            display: none;
            position: absolute;
            bottom: 125%;
            left: -100px;
            width: 300px;
            background: #333;
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 100px;
            border: 6px solid transparent;
            border-top-color: #333;
        }

        .section {
            background: #FAFAFA;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #E8E8E8;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #222222;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333333;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-secondary {
            background: #E8E8E8;
            color: #333333;
        }

        .btn-secondary:hover {
            background: #D0D0D0;
        }

        .btn-primary {
            background: #0069E0;
            color: white;
            min-width: 120px;
        }

        .btn-primary:hover {
            background: #0052B3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .fields-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 15px;
            background: white;
            border: 1px solid #E8E8E8;
            border-radius: 4px;
        }

        .field-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .field-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
            user-select: none;
        }

        .category {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #0069E0;
        }

        .category-title {
            font-weight: bold;
            color: #0069E0;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .category-fields {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .code-output {
            background: white;
            border: 1px solid #E8E8E8;
            border-radius: 4px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 600px;
            overflow-y: auto;
            color: #333;
        }

        .copy-btn {
            margin-top: 15px;
        }

        .download-btn {
            margin-left: 10px;
        }

        pre {
            margin: 0;
        }

        .tip {
            background: #E7F3FF;
            border-left: 4px solid #0069E0;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #004085;
        }

        .tip strong {
            color: #0069E0;
        }

        .author-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid #E8E8E8;
            font-size: 12px;
            color: #999;
        }

        .author-name {
            font-weight: 500;
            color: #666;
        }

        .separator {
            color: #DDD;
        }

        .author-info a {
            color: #0069E0;
            text-decoration: none;
            transition: color 0.3s;
        }

        .author-info a:hover {
            color: #0052B3;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é…ç½®é¢æ¿ -->
        <div class="panel config-panel">
            <h1>ğŸ“Š Zoteroæ–‡çŒ®çŸ©é˜µè„šæœ¬ç”Ÿæˆå™¨
                <span class="help-btn">?
                    <span class="tooltip">ğŸ“– ä½¿ç”¨æ–¹å¼ï¼š
1. å‹¾é€‰è¦æå–çš„å…ƒæ•°æ®å­—æ®µ
2. ç‚¹å‡»"ç”Ÿæˆè„šæœ¬"æŒ‰é’®
3. å¤åˆ¶ç”Ÿæˆçš„ä»£ç æˆ–ç›´æ¥ä¸‹è½½ä¸º .js æ–‡ä»¶
4. åœ¨ Zotero ä¸­è¿è¡Œè„šæœ¬
   - é€‰æ‹©è¦å¤„ç†çš„æ¡ç›®
   - å·¥å…· > Actions and Tags > Run JavaScript
   - åŠ è½½ç”Ÿæˆçš„è„šæœ¬æ–‡ä»¶

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- æ‰«æPDFæ³¨é‡Šæ ‡ç­¾
- è®©ç”¨æˆ·é€‰æ‹©è¦æå–çš„æ ‡ç­¾
- åˆ é™¤æ—§ç¬”è®°é¿å…é‡å¤
- æå–å…ƒæ•°æ®å’Œæ³¨é‡Š
- ç”Ÿæˆè¡¨æ ¼ç¬”è®°

æ³¨é‡Šæå–åŠŸèƒ½ç”±è„šæœ¬è‡ªåŠ¨å¤„ç†ï¼Œ
æœ¬ç”Ÿæˆå™¨ä»…ç”¨äºé…ç½®å…ƒæ•°æ®å­—æ®µã€‚</span>
                </span>
            </h1>
            <p class="subtitle">é€‰æ‹©è¦æå–çš„å…ƒæ•°æ®å­—æ®µï¼Œè‡ªåŠ¨ç”Ÿæˆæ–‡çŒ®çŸ©é˜µè„šæœ¬</p>

            <div class="tip">
                <strong>ğŸ’¡ æç¤ºï¼š</strong>è„šæœ¬çš„æ³¨é‡Šæå–åŠŸèƒ½å·²å†…ç½®ï¼Œæœ¬ç”Ÿæˆå™¨åªéœ€é…ç½®å…ƒæ•°æ®å­—æ®µã€‚é€‰æ‹©çš„å­—æ®µå°†ä½œä¸ºè¡¨æ ¼çš„åˆ—æ˜¾ç¤ºåœ¨æ³¨é‡Šåˆ—ä¹‹åã€‚
            </div>

            <!-- å…ƒæ•°æ®å­—æ®µé€‰æ‹© -->
            <div class="section">
                <div class="section-title">ğŸ”§ å…ƒæ•°æ®å­—æ®µé…ç½®</div>

                <div class="btn-group">
                    <button class="btn-secondary" onclick="selectAllFields()">å…¨é€‰</button>
                    <button class="btn-secondary" onclick="deselectAllFields()">å…¨ä¸é€‰</button>
                </div>

                <div id="fieldsContainer"></div>
            </div>

            <!-- ç”ŸæˆæŒ‰é’® -->
            <div class="section">
                <button class="btn-primary" onclick="generateScript()">ğŸ”„ ç”Ÿæˆè„šæœ¬</button>
            </div>
        </div>

        <!-- ä»£ç è¾“å‡ºé¢æ¿ -->
        <div class="panel code-panel">
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                <h2 style="color: #222; margin: 0; flex: 1;">ğŸ“ ç”Ÿæˆçš„è„šæœ¬ä»£ç </h2>
                <button class="btn-success copy-btn" onclick="copyCode()" style="margin: 0;">ğŸ“‹ å¤åˆ¶ä»£ç </button>
                <button class="btn-success download-btn" onclick="downloadScript()" style="margin: 0; margin-left: 0;">â¬‡ï¸ ä¸‹è½½è„šæœ¬</button>
            </div>
            <div class="code-output" id="codeOutput">ç‚¹å‡»"ç”Ÿæˆè„šæœ¬"æŒ‰é’®æ¥ç”Ÿæˆæ–‡çŒ®çŸ©é˜µè„šæœ¬...</div>
        </div>

        <!-- ä½œè€…ä¿¡æ¯ -->
        <div class="author-info">
            <span class="author-name">ä½œè€…: Stream-L</span>
            <span class="separator">|</span>
            <a href="https://stream-l.github.io/" target="_blank" rel="noopener">åšå®¢</a>
        </div>
    </div>

    <script>
        // å…ƒæ•°æ®å­—æ®µå®šä¹‰ï¼ˆåŸºäº all_matrix.jsï¼‰
        const METADATA_FIELDS = {
            all: [
                { id: 'title', name: 'æ ‡é¢˜', variable: 'title' },
                { id: 'creators', name: 'ä½œè€…', variable: 'creators', isSpecial: true },
                { id: 'date', name: 'æ—¥æœŸ', variable: 'date' },
                { id: 'year', name: 'å¹´ä»½', variable: 'year' },
                { id: 'abstractNote', name: 'æ‘˜è¦', variable: 'abstractNote' },
                { id: 'itemType', name: 'æ–‡çŒ®ç±»å‹', variable: 'itemType', isSpecial: true },
                { id: 'url', name: 'URL', variable: 'url' },
                { id: 'DOI', name: 'DOI', variable: 'DOI' },
                { id: 'ISBN', name: 'ISBN', variable: 'ISBN' },
                { id: 'ISSN', name: 'ISSN', variable: 'ISSN' },
                { id: 'accessDate', name: 'è®¿é—®æ—¥æœŸ', variable: 'accessDate' },
                { id: 'language', name: 'è¯­è¨€', variable: 'language' },
                { id: 'libraryCatalog', name: 'æ–‡åº“ç¼–ç›®', variable: 'libraryCatalog' },
                { id: 'pages', name: 'é¡µç ', variable: 'pages' },
                { id: 'place', name: 'å‡ºç‰ˆåœ°', variable: 'place' },
                { id: 'publisher', name: 'å‡ºç‰ˆç¤¾', variable: 'publisher' },
                { id: 'publicationTitle', name: 'æœŸåˆŠ/å‡ºç‰ˆç‰©', variable: 'publicationTitle' },
                { id: 'journalAbbreviation', name: 'æœŸåˆŠç¼©å†™', variable: 'journalAbbreviation' },
                { id: 'volume', name: 'å·', variable: 'volume' },
                { id: 'issue', name: 'æœŸå·', variable: 'issue' },
                { id: 'series', name: 'ç³»åˆ—', variable: 'series' },
                { id: 'seriesNumber', name: 'ç³»åˆ—ç¼–å·', variable: 'seriesNumber' },
                { id: 'edition', name: 'ç‰ˆæœ¬', variable: 'edition' },
                { id: 'shortTitle', name: 'çŸ­æ ‡é¢˜', variable: 'shortTitle' },
                { id: 'titleTranslation', name: 'æ ‡é¢˜ç¿»è¯‘', variable: 'titleTranslation' },
                { id: 'abstractTranslation', name: 'æ‘˜è¦ç¿»è¯‘', variable: 'abstractTranslation' },
                { id: 'bookTitle', name: 'å›¾ä¹¦æ ‡é¢˜', variable: 'bookTitle' },
                { id: 'thesisType', name: 'å­¦ä½ç±»å‹', variable: 'thesisType' },
                { id: 'university', name: 'å¤§å­¦', variable: 'university' },
                { id: 'conferenceName', name: 'ä¼šè®®åç§°', variable: 'conferenceName' },
                { id: 'manuscriptType', name: 'æ–‡æ¡£ç±»å‹', variable: 'manuscriptType' },
                { id: 'reportNumber', name: 'æŠ¥å‘Šç¼–å·', variable: 'reportNumber' },
                { id: 'reportType', name: 'æŠ¥å‘Šç±»å‹', variable: 'reportType' },
                { id: 'archive', name: 'æ¡£æ¡ˆ', variable: 'archive' },
                { id: 'archiveLocation', name: 'æ¡£æ¡ˆä½ç½®', variable: 'archiveLocation' },
                { id: 'callNumber', name: 'ç´¢ä¹¦å·', variable: 'callNumber' },
                { id: 'rights', name: 'æƒåˆ©', variable: 'rights' },
                { id: 'extra', name: 'é™„åŠ ä¿¡æ¯', variable: 'extra' },
                { id: 'tags', name: 'æ ‡ç­¾', variable: 'tags', isSpecial: true },
                { id: 'attachmentCount', name: 'é™„ä»¶æ•°é‡', variable: null, isSpecial: true },
                { id: 'firstAttachmentName', name: 'ç¬¬ä¸€ä¸ªé™„ä»¶åç§°', variable: null, isSpecial: true },
                { id: 'attachmentLink', name: 'é™„ä»¶é“¾æ¥', variable: null, isSpecial: true },
                { id: 'noteCount', name: 'å­ç¬”è®°æ•°é‡', variable: null, isSpecial: true },
                { id: 'key', name: 'é¡¹ç›®é”®', variable: 'key', isSpecial: true },
                { id: 'id', name: 'é¡¹ç›®ID', variable: 'id', isSpecial: true },
                { id: 'libraryID', name: 'å›¾ä¹¦é¦†ID', variable: 'libraryID', isSpecial: true },
                { id: 'dateAdded', name: 'æ·»åŠ æ—¥æœŸ', variable: 'dateAdded' },
                { id: 'dateModified', name: 'ä¿®æ”¹æ—¥æœŸ', variable: 'dateModified' }
            ]
        };

        // é»˜è®¤é€‰æ‹©çš„å­—æ®µ
        const DEFAULT_SELECTED = ['title', 'creators', 'date', 'abstractNote', 'DOI', 'attachmentLink'];

        // åˆå§‹åŒ–å­—æ®µUI
        function initializeFields() {
            const container = document.getElementById('fieldsContainer');
            container.innerHTML = '';

            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';

            const titleDiv = document.createElement('div');
            titleDiv.className = 'category-title';
            titleDiv.textContent = 'æ‰€æœ‰å…ƒæ•°æ®å­—æ®µ (å…± ' + METADATA_FIELDS.all.length + ' ä¸ª)';
            categoryDiv.appendChild(titleDiv);

            const fieldsDiv = document.createElement('div');
            fieldsDiv.className = 'category-fields';

            METADATA_FIELDS.all.forEach(field => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'field-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `field_${field.id}`;
                checkbox.value = field.id;

                // æ ¹æ® DEFAULT_SELECTED è®¾ç½®é»˜è®¤é€‰ä¸­
                if (DEFAULT_SELECTED.includes(field.id)) {
                    checkbox.checked = true;
                }

                const label = document.createElement('label');
                label.htmlFor = `field_${field.id}`;
                label.textContent = field.name;

                fieldDiv.appendChild(checkbox);
                fieldDiv.appendChild(label);
                fieldsDiv.appendChild(fieldDiv);
            });

            categoryDiv.appendChild(fieldsDiv);
            container.appendChild(categoryDiv);
        }

        // å¿«é€‰å‡½æ•°
        function selectFieldsByCategory(category) {
            // ä¿ç•™å‘åå…¼å®¹ï¼Œä½†å®é™…ä¸ç”¨äº†
            selectAllFields();
        }

        function selectAllFields() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function deselectAllFields() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        // è·å–é€‰ä¸­çš„å­—æ®µ
        function getSelectedFields() {
            const selected = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                const field = METADATA_FIELDS.all.find(f => f.id === cb.value);
                if (field) {
                    selected.push(field);
                }
            });
            return selected;
        }

        // ç”Ÿæˆè„šæœ¬
        function generateScript() {
            const selectedFields = getSelectedFields();
            if (selectedFields.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå…ƒæ•°æ®å­—æ®µï¼');
                return;
            }

            // ç”Ÿæˆå…ƒæ•°æ®å­—æ®µå®šä¹‰
            let fieldsCode = '// å®šä¹‰æ‰€æœ‰è¦æå–çš„å…ƒæ•°æ®å­—æ®µ\n';
            fieldsCode += 'const METADATA_FIELDS = [\n';

            selectedFields.forEach((field, index) => {
                const fieldDef = `  { name: "${field.name}", variable: "${field.variable || 'null'}"${field.isSpecial ? ', isSpecial: true' : ''} }`;
                fieldsCode += fieldDef + (index < selectedFields.length - 1 ? ',' : '');
                fieldsCode += '\n';
            });

            fieldsCode += '];\n\n';

            // è¯»å–åŸºç¡€è„šæœ¬å¹¶æ›¿æ¢å…ƒæ•°æ®å®šä¹‰
            const baseScript = getBaseScript();
            const scriptCode = baseScript.replace(
                /\/\/ å®šä¹‰æ‰€æœ‰è¦æå–çš„å…ƒæ•°æ®å­—æ®µ[\s\S]*?const METADATA_FIELDS = \[[\s\S]*?\];\s*\n/,
                fieldsCode
            );

            document.getElementById('codeOutput').textContent = scriptCode;
        }

        // è·å–åŸºç¡€è„šæœ¬æ¨¡æ¿
        function getBaseScript() {
            return `/**
 * @author Mulei
 * è„šæœ¬åŠŸèƒ½ï¼šä»æ‰€æœ‰é€‰ä¸­çš„æ¡ç›®ä¸­æå–æŒ‡å®š PDF é™„ä»¶å†…å¸¦æœ‰æŒ‡å®š"æ³¨é‡Šæ ‡ç­¾"çš„æ³¨é‡Šï¼ˆè½¬æ¢ä¸º HTMLï¼‰ï¼Œ
 * åŒæ—¶æå–æ‰€æœ‰å…ƒæ•°æ®å­—æ®µï¼Œå¹¶å°†ç»“æœåˆå¹¶åˆ°ä¸€ä¸ªè¡¨æ ¼ä¸­ã€‚
 * 
 * ä½¿ç”¨è¯´æ˜ï¼š
 * 1. åœ¨ Zotero ä¸­ï¼Œä½¿ç”¨è‡ªå¸¦çš„ PDF é˜…è¯»å™¨æ‰“å¼€ PDFï¼Œå¹¶å¯¹éœ€è¦çš„æ–‡å­—åšé«˜äº®æˆ–æ³¨é‡Šï¼Œç„¶ååœ¨æ³¨é‡Šçš„å³ä¾§é¢æ¿ä¸­æ·»åŠ æ ‡ç­¾ï¼ˆtagï¼‰ï¼Œå¦‚"èƒŒæ™¯"ã€"ææ–™"ã€‚
 * 2. é€‰ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªæ¡ç›®åè¿è¡Œæ­¤è„šæœ¬ï¼ˆä½¿ç”¨ä¼ å…¥çš„ items æˆ– item å˜é‡ï¼‰ã€‚
 * 3. è„šæœ¬ä¼šå¼¹çª—æç¤ºè¾“å…¥æ–°ç¬”è®°çš„æ ‡é¢˜å’Œè¦æå–çš„æ³¨é‡Šæ ‡ç­¾ã€‚
 * 4. è„šæœ¬ä¼šå…ˆè‡ªåŠ¨åˆ é™¤æ¯ä¸ªæ¡ç›®ä¸­å·²ç”Ÿæˆçš„ã€åŒ…å«è¿™äº›æ ‡ç­¾å…³é”®å­—çš„æå–æ³¨é‡Šç¬”è®°ï¼ˆé¿å…é‡å¤ï¼‰ã€‚
 * 5. ç„¶åéå†æ¯ä¸ªæ¡ç›®ï¼Œæå–æ³¨é‡Šå’Œæ‰€æœ‰å…ƒæ•°æ®å­—æ®µã€‚
 * 6. æœ€åç”ŸæˆåŒ…å«æ³¨é‡Šåˆ—å’Œå…ƒæ•°æ®åˆ—çš„è¡¨æ ¼ç¬”è®°ã€‚
 * 
 * è¡¨æ ¼ç»“æ„ï¼šæ¯è¡Œæ˜¯ä¸€ä¸ªæ¡ç›®ï¼Œåˆ—åŒ…æ‹¬ï¼šå…ƒæ•°æ®å­—æ®µåˆ— + æ³¨é‡Šæ ‡ç­¾åˆ—
 */

if (item) return; // ä»…å¯¹æ‰€æœ‰é€‰ä¸­é¡¹æ‰§è¡Œä¸€æ¬¡

const Zotero = require("Zotero");
const window = require("window");
const console = require("console");

// ä½¿ç”¨ä¼ å…¥çš„ items æˆ– item å˜é‡
let selectedItems = [];
if (typeof items !== "undefined" && items.length > 0) {
  selectedItems = items;
} else if (typeof item !== "undefined") {
  selectedItems = [item];
} else {
  window.alert("è¯·å…ˆé€‰æ‹©è¦å¤„ç†çš„æ–‡çŒ®");
  return;
}

// å¼¹çª—æç¤ºè¾“å…¥æ–°ç¬”è®°çš„æ ‡é¢˜
let noteTitle = window.prompt("è¯·è¾“å…¥æ–°ç¬”è®°çš„æ ‡é¢˜ï¼šï¼ˆé»˜è®¤ä½¿ç”¨å½“å‰æ—¶é—´ï¼‰");
if (!noteTitle) {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');
  noteTitle = \`\${year}-\${month}-\${day} \${hours}:\${minutes}:\${seconds}\`;
}

// åˆ›å»ºè¿›åº¦çª—å£
let progressWindow = new Zotero.ProgressWindow({ closeOnClick: false });
progressWindow.changeHeadline("æå–æ³¨é‡Šå’Œå…ƒæ•°æ®åˆ°è¡¨æ ¼");
progressWindow.show();

let progressIcon = 'chrome://zotero/skin/spinner-16px.png';
let itemProgress = new progressWindow.ItemProgress(progressIcon, noteTitle.substring(0, 60));
itemProgress.setProgress(0);
itemProgress.setText("â³ æ­£åœ¨æ‰«ææ³¨é‡Šæ ‡ç­¾...");
progressWindow.show();

/**
 * ä»æ‰€æœ‰é€‰ä¸­çš„æ¡ç›®ä¸­æå–æ‰€æœ‰æ³¨é‡Šæ ‡ç­¾
 */
async function getAllAnnotationTags(items) {
  let allTags = new Set();
  
  for (let item of items) {
    if (item.isAttachment()) {
      console.log(\`[DEBUG] è·³è¿‡é™„ä»¶é¡¹ç›®: \${item.id}\`);
      continue;
    }
    
    const attachments = item.getAttachments();
    for (let attachmentId of attachments) {
      const attachment = await Zotero.Items.getAsync(attachmentId);
      if (attachment.attachmentContentType === "application/pdf") {
        const annots = attachment.getAnnotations();
        if (annots && annots.length > 0) {
          for (let annot of annots) {
            if (annot.getTags && Array.isArray(annot.getTags())) {
              let tagsOnAnnot = annot.getTags().map(tagObj => tagObj.tag);
              tagsOnAnnot.forEach(tag => allTags.add(tag));
            }
          }
        }
      }
    }
  }
  
  return Array.from(allTags).sort();
}

// æå–æ‰€æœ‰æ³¨é‡Šæ ‡ç­¾
let availableTags = await getAllAnnotationTags(selectedItems);

if (availableTags.length === 0) {
  itemProgress.setError();
  itemProgress.setText("âŒ æœªæ‰¾åˆ°ä»»ä½•å¸¦æ ‡ç­¾çš„æ³¨é‡Š");
  progressWindow.startCloseTimer(4000);
  return;
}

itemProgress.setProgress(20);
itemProgress.setText(\`âœ“ æ‰¾åˆ° \${availableTags.length} ä¸ªæ ‡ç­¾\`);

// è®©ç”¨æˆ·å¤šé€‰æ ‡ç­¾
let tagSelection = window.prompt(
  \`æ‰¾åˆ°ä»¥ä¸‹æ³¨é‡Šæ ‡ç­¾ï¼š\\n\\n\${availableTags.map((tag, idx) => \`\${idx + 1}. \${tag}\`).join('\\n')}\\n\\nè¯·è¾“å…¥è¦æå–çš„æ ‡ç­¾åºå·ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼š1,3,5ï¼‰\\næˆ–ç›´æ¥è¾“å…¥æ ‡ç­¾åç§°ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰\\nè¾“å…¥ 0 å¯å…¨é€‰æ‰€æœ‰æ ‡ç­¾ï¼š\`
);

if (!tagSelection) {
  itemProgress.setError();
  itemProgress.setText("âŒ æœªé€‰æ‹©æ ‡ç­¾");
  progressWindow.startCloseTimer(3000);
  return;
}

itemProgress.setProgress(25);
itemProgress.setText("â³ æ­£åœ¨è§£ææ ‡ç­¾é€‰æ‹©...");

// è§£æç”¨æˆ·è¾“å…¥
let annotationTags = [];

if (tagSelection.trim() === '0') {
  annotationTags = [...availableTags];
} else {
  let inputs = tagSelection.split(/[,ï¼Œ;ï¼›]/).map(s => s.trim()).filter(s => s.length > 0);

  for (let input of inputs) {
    if (/^\\d+$/.test(input)) {
      let index = parseInt(input) - 1;
      if (index >= 0 && index < availableTags.length) {
        annotationTags.push(availableTags[index]);
      }
    } else {
      if (availableTags.includes(input)) {
        annotationTags.push(input);
      }
    }
  }

  annotationTags = [...new Set(annotationTags)];
}

if (annotationTags.length === 0) {
  itemProgress.setError();
  itemProgress.setText("âŒ æ²¡æœ‰æœ‰æ•ˆçš„æ ‡ç­¾é€‰æ‹©");
  progressWindow.startCloseTimer(3000);
  return;
}

itemProgress.setProgress(30);
itemProgress.setText(\`âœ“ å·²é€‰æ‹© \${annotationTags.length} ä¸ªæ ‡ç­¾: \${annotationTags.join(", ")}\`);

// å®šä¹‰æ‰€æœ‰è¦æå–çš„å…ƒæ•°æ®å­—æ®µ
const METADATA_FIELDS = [
  { name: "æ ‡é¢˜", variable: "title" },
  { name: "ä½œè€…", variable: "creators", isSpecial: true }
];

console.log(\`[DEBUG] æ€»å­—æ®µæ•°: \${METADATA_FIELDS.length}\`);
console.log(\`[DEBUG] æ³¨é‡Šæ ‡ç­¾æ•°: \${annotationTags.length}\`);

/**
 * åˆ é™¤æ¯ä¸ªæ¡ç›®ä¸­å·²ç”Ÿæˆçš„ã€åŒ…å«ä»»ä¸€æŒ‡å®šæ³¨é‡Šæ ‡ç­¾å…³é”®å­—çš„æå–æ³¨é‡Šç¬”è®°
 */
async function deleteIndividualAnnotationNotes(items, annotationTags) {
  itemProgress.setProgress(35);
  itemProgress.setText("â³ æ­£åœ¨åˆ é™¤æ—§ç¬”è®°...");
  
  let deletedCount = 0;
  for (let item of items) {
    if (item.isAttachment()) {
      console.log(\`[DEBUG] è·³è¿‡é™„ä»¶é¡¹ç›®: \${item.id}\`);
      continue;
    }
    
    const noteIDs = item.getNotes();
    console.log(\`[DEBUG] æ¡ç›® "\${item.getField("title")}" æœ‰ \${noteIDs.length} ä¸ªç¬”è®°\`);
    for (let id of noteIDs) {
      let note = Zotero.Items.get(id);
      let noteHTML = note.getNote();
      if (noteHTML && noteHTML.startsWith('<div data-citation-items')) {
        if (annotationTags.some(tag => noteHTML.includes(tag))) {
          Zotero.Items.trashTx(id);
          deletedCount++;
          console.log(\`[DEBUG] åˆ é™¤æ—§ç¬”è®°: \${note.getNoteTitle()}\`);
        }
      }
    }
  }
  
  if (deletedCount > 0) {
    itemProgress.setText(\`âœ“ å·²åˆ é™¤ \${deletedCount} ä¸ªæ—§ç¬”è®°\`);
  }
}

/**
 * ä»å•ä¸ªæ¡ç›®ä¸­ï¼Œæå–å…¶ PDF é™„ä»¶ä¸­æ‰€æœ‰å¸¦æœ‰ annotationTags ä¸­ä»»æ„ä¸€ä¸ªæ ‡ç­¾çš„æ³¨é‡Š
 */
async function extractAnnotationsFromItem(item) {
  let annotationsObj = {};
  annotationTags.forEach(tag => {
    annotationsObj[tag] = "";
  });
  
  if (item.isAttachment()) {
    console.log(\`[DEBUG] è·³è¿‡é™„ä»¶é¡¹ç›®: \${item.id}\`);
    return annotationsObj;
  }
  
  const attachments = item.getAttachments();
  console.log(\`[DEBUG] æ¡ç›® "\${item.getField("title")}" æœ‰ \${attachments.length} ä¸ªé™„ä»¶\`);
  
  let foundAnnotationsCount = 0;
  for (let attachmentId of attachments) {
    const attachment = await Zotero.Items.getAsync(attachmentId);
    if (attachment.attachmentContentType === "application/pdf") {
      const annots = attachment.getAnnotations();
      console.log(\`[DEBUG] PDFé™„ä»¶æœ‰ \${annots ? annots.length : 0} ä¸ªæ³¨é‡Š\`);
      if (annots && annots.length > 0) {
        for (let annot of annots) {
          if (annot.getTags && Array.isArray(annot.getTags())) {
            let tagsOnAnnot = annot.getTags().map(tagObj => tagObj.tag);
            for (let wantedTag of annotationTags) {
              if (tagsOnAnnot.includes(wantedTag)) {
                foundAnnotationsCount++;
                try {
                  let annotJSON = await Zotero.Annotations.toJSON(annot);
                  let res = Zotero.EditorInstanceUtilities.serializeAnnotations([
                    { ...annotJSON, attachmentItemID: annot.parentID }
                  ]);
                  let cleanHTML = res.html;
                  if (cleanHTML.startsWith('<div') && cleanHTML.endsWith('</div>')) {
                    cleanHTML = cleanHTML.replace(/^<div[^>]*>/, '').replace(/<\\/div>$/, '');
                  }
                  annotationsObj[wantedTag] += cleanHTML;
                  console.log(\`[DEBUG] æ‰¾åˆ°æ ‡ç­¾"\${wantedTag}"çš„æ³¨é‡Š\`);
                } catch (error) {
                  console.error("è½¬æ¢æ³¨é‡Šä¸º HTML æ—¶å‡ºé”™:", error);
                }
              }
            }
          }
        }
      }
    }
  }
  
  console.log(\`[DEBUG] æ¡ç›® "\${item.getField("title")}" å…±æ‰¾åˆ° \${foundAnnotationsCount} ä¸ªåŒ¹é…çš„æ³¨é‡Š\`);
  return annotationsObj;
}

/**
 * ä»æ¡ç›®ä¸­æå–å•ä¸ªå­—æ®µçš„å€¼
 */
function extractFieldValue(item, field) {
  try {
    if (field.isSpecial) {
      switch (field.name) {
        case "ä½œè€…":
          let creators = item.getCreators();
          if (!creators || creators.length === 0) return "";
          return creators.map(c => {
            if (c.firstName && c.lastName) {
              return \`\${c.lastName}, \${c.firstName}\`;
            } else if (c.name) {
              return c.name;
            } else if (c.lastName) {
              return c.lastName;
            } else {
              return "";
            }
          }).filter(n => n).join("; ");
        
        case "æ–‡çŒ®ç±»å‹":
          return Zotero.ItemTypes.getLocalizedString(item.itemTypeID) || item.itemType || "";
        
        case "é™„ä»¶æ•°é‡":
          let attachments = Zotero.Items.get(item.getAttachments());
          return attachments ? attachments.length.toString() : "0";
        
        case "å­ç¬”è®°æ•°é‡":
          let notes = item.getNotes();
          return notes ? notes.length.toString() : "0";
        
        case "é¡¹ç›®é”®":
          return item.key || "";
        
        case "é¡¹ç›®ID":
          return item.id ? item.id.toString() : "";
        
        case "å›¾ä¹¦é¦†ID":
          return item.libraryID ? item.libraryID.toString() : "";
        
        case "æ ‡ç­¾":
          let tags = item.getTags();
          if (!tags || tags.length === 0) return "";
          return tags.map(t => t.tag).join(", ");
        
        case "ç¬¬ä¸€ä¸ªé™„ä»¶åç§°":
          let attList = Zotero.Items.get(item.getAttachments());
          if (!attList || attList.length === 0) return "";
          return attList[0].getField("title") || "";
        
        case "é™„ä»¶é“¾æ¥":
          let attList2 = Zotero.Items.get(item.getAttachments());
          if (!attList2 || attList2.length === 0) return "";
          let firstAtt = attList2[0];
          if (firstAtt.isFileAttachment()) {
            return \`zotero://open-pdf/library/items/\${firstAtt.key}\`;
          } else if (firstAtt.isLinkAttachment()) {
            return firstAtt.getField("url") || "";
          }
          return "";
        
        default:
          return "";
      }
    }
    
    if (!field.variable) {
      return "";
    }
    
    let value = item.getField(field.variable, false, true);
    return value || "";
    
  } catch (error) {
    console.log(\`[DEBUG] æå–å­—æ®µ "\${field.name}" å¤±è´¥:\`, error);
    return "";
  }
}

/**
 * ä»å•ä¸ªæ¡ç›®ä¸­æå–æ‰€æœ‰å…ƒæ•°æ®
 */
function extractMetadataFromItem(item) {
  let metadata = {};
  
  for (let field of METADATA_FIELDS) {
    metadata[field.name] = extractFieldValue(item, field);
  }
  
  return metadata;
}

/**
 * ä¸»å¤„ç†å‡½æ•°ï¼šæå–æ‰€æœ‰æ¡ç›®çš„æ³¨é‡Šå’Œå…ƒæ•°æ®å¹¶ç”Ÿæˆè¡¨æ ¼
 */
async function combineAnnotationsAndMetadata(items) {
  itemProgress.setProgress(40);
  itemProgress.setText(\`â³ æ­£åœ¨å¤„ç† \${items.length} ä¸ªæ¡ç›®...\`);
  
  let tableData = [];
  let processedCount = 0;
  
  for (let item of items) {
    if (item.isAttachment()) {
      console.log(\`[DEBUG] è·³è¿‡é™„ä»¶é¡¹ç›®: \${item.id}\`);
      continue;
    }
    
    let title = item.getField("title") || "æ— æ ‡é¢˜";
    console.log(\`[DEBUG] æ­£åœ¨å¤„ç†æ¡ç›®: \${title}\`);
    
    processedCount++;
    let progress = 40 + Math.floor((processedCount / items.length) * 40);
    itemProgress.setProgress(progress);
    itemProgress.setText(\`â³ æ­£åœ¨æå–æ•°æ® (\${processedCount}/\${items.length}): \${title.substring(0, 30)}...\`);
    
    try {
      let itemAnnotations = await extractAnnotationsFromItem(item);
      let metadata = extractMetadataFromItem(item);
      tableData.push({ 
        annotations: itemAnnotations,
        metadata: metadata
      });
    } catch (error) {
      console.error(\`å¤„ç†æ–‡çŒ® "\${title}" æ—¶å‡ºé”™:\`, error);
    }
  }
  
  if (tableData.length === 0) {
    itemProgress.setError();
    itemProgress.setText("âŒ æœªèƒ½æå–ä»»ä½•æ•°æ®");
    progressWindow.startCloseTimer(4000);
    return;
  }
  
  itemProgress.setProgress(80);
  itemProgress.setText(\`âœ“ å·²æå– \${tableData.length} ä¸ªæ¡ç›®çš„æ•°æ®\`);
  
  // æ„å»º HTML è¡¨æ ¼
  let combinedHTML = \`<h1>\${noteTitle}</h1>\\n\`;
  combinedHTML += \`<p>å…± \${tableData.length} ä¸ªæ¡ç›®ï¼Œ\${METADATA_FIELDS.length} ä¸ªå…ƒæ•°æ®å­—æ®µï¼Œ\${annotationTags.length} ä¸ªæ³¨é‡Šæ ‡ç­¾</p>\\n\`;
  combinedHTML += \`<table border="1" cellspacing="0" cellpadding="5" style="border-collapse: collapse; width: 100%;">\\n\`;
  
  // è¡¨å¤´ï¼šå…ˆæ˜¯å…ƒæ•°æ®å­—æ®µåˆ—ï¼Œåæ˜¯æ³¨é‡Šæ ‡ç­¾åˆ—
  combinedHTML += \`<tr style="background-color: #f0f0f0; font-weight: bold;">\`;
  
  for (let field of METADATA_FIELDS) {
    combinedHTML += \`<th style="text-align: left; padding: 8px; white-space: nowrap;">\${field.name}</th>\`;
  }
  
  annotationTags.forEach(tag => {
    combinedHTML += \`<th style="text-align: left; padding: 8px; white-space: nowrap; background-color: #e8f4f8;">\${tag}</th>\`;
  });
  
  combinedHTML += \`</tr>\\n\`;
  
  // æ•°æ®è¡Œ
  tableData.forEach((row, index) => {
    let bgColor = index % 2 === 0 ? "#ffffff" : "#f9f9f9";
    combinedHTML += \`<tr style="background-color: \${bgColor};\">\`;
    
    for (let field of METADATA_FIELDS) {
      let cellValue = row.metadata[field.name] || "";
      cellValue = cellValue.replace(/&/g, "&amp;")
                           .replace(/</g, "&lt;")
                           .replace(/>/g, "&gt;")
                           .replace(/"/g, "&quot;")
                           .replace(/'/g, "&#39;");
      
      let displayValue = cellValue;
      if (cellValue.length > 100) {
        displayValue = cellValue.substring(0, 100) + "...";
      }
      
      combinedHTML += \`<td style="padding: 8px; vertical-align: top;">\${displayValue}</td>\`;
    }
    
    annotationTags.forEach(tag => {
      let cellContent = row.annotations[tag] || "";
      combinedHTML += \`<td style="padding: 8px; vertical-align: top;">\${cellContent}</td>\`;
    });
    
    combinedHTML += \`</tr>\\n\`;
  });
  
  combinedHTML += \`</table>\\n\`;
  
  itemProgress.setProgress(85);
  itemProgress.setText("â³ æ­£åœ¨åˆ›å»ºç¬”è®°...");
  
  let currentItem = items[0];
  let libraryID = currentItem.libraryID;
  console.log(\`[DEBUG] åº“ID: \${libraryID}\`);
  
  let library = Zotero.Libraries.get(libraryID);
  console.log(\`[DEBUG] åº“åç§°: \${library.name}, å¯ç¼–è¾‘: \${library.editable}\`);
  if (!library.editable) {
    itemProgress.setError();
    itemProgress.setText("âŒ è¯¥åº“ä¸ºåªè¯»çŠ¶æ€ï¼Œæ— æ³•åˆ›å»ºç¬”è®°");
    progressWindow.startCloseTimer(4000);
    return null;
  }
  
  let collectionID = null;
  try {
    let zoteroPane = Zotero.getActiveZoteroPane();
    if (zoteroPane) {
      let selectedCollection = zoteroPane.getSelectedCollection(true);
      if (selectedCollection) {
        collectionID = selectedCollection;
        console.log(\`[DEBUG] å½“å‰åˆ†ç±»ID: \${collectionID}\`);
      }
    }
  } catch (e) {
    console.log("[DEBUG] æ— æ³•è·å–å½“å‰åˆ†ç±»:", e);
  }
  
  itemProgress.setProgress(90);
  itemProgress.setText("â³ æ­£åœ¨ä¿å­˜ç¬”è®°...");
  
  let noteItem = new Zotero.Item("note");
  noteItem.libraryID = libraryID;
  noteItem.parentID = null;
  console.log(\`[DEBUG] ç¬”è®°parentIDè®¾ç½®ä¸ºnull(ç‹¬ç«‹ç¬”è®°)\`);
  
  if (collectionID) {
    noteItem.addToCollection(collectionID);
    console.log(\`[DEBUG] ç¬”è®°å·²æ·»åŠ åˆ°åˆ†ç±»: \${collectionID}\`);
  }
  
  noteItem.setNote(combinedHTML);
  console.log(\`[DEBUG] ç¬”è®°å†…å®¹å·²è®¾ç½®,é•¿åº¦: \${combinedHTML.length}\`);
  
  await noteItem.saveTx();
  console.log(\`[DEBUG] ç¬”è®°å·²ä¿å­˜,ID: \${noteItem.id}\`);
  
  itemProgress.setProgress(100);
  itemProgress.setText(\`âœ… æˆåŠŸåˆ›å»ºç¬”è®°: \${noteTitle}\`);
  progressWindow.startCloseTimer(3000);
  
  return noteItem;
}

// å…ˆåˆ é™¤æ—§çš„æå–ç¬”è®°ï¼Œå†åˆå¹¶ç”Ÿæˆæ–°çš„ç‹¬ç«‹ç¬”è®°
deleteIndividualAnnotationNotes(selectedItems, annotationTags).then(() => {
  combineAnnotationsAndMetadata(selectedItems).then((noteItem) => {
    if (!noteItem) {
      itemProgress.setError();
      itemProgress.setText("âŒ å¤„ç†è¿‡ç¨‹ä¸­æœªèƒ½åˆ›å»ºç¬”è®°");
      progressWindow.startCloseTimer(4000);
    }
  }).catch((error) => {
    console.error("åˆå¹¶æ³¨é‡Šå’Œå…ƒæ•°æ®æ—¶å‡ºé”™:", error);
    itemProgress.setError();
    itemProgress.setText(\`âŒ é”™è¯¯: \${error.message}\`);
    progressWindow.startCloseTimer(5000);
  });
}).catch((error) => {
  console.error("åˆ é™¤æ—§ç¬”è®°æ—¶å‡ºé”™:", error);
  itemProgress.setError();
  itemProgress.setText(\`âŒ é”™è¯¯: \${error.message}\`);
  progressWindow.startCloseTimer(5000);
});`;
        }

        // å¤åˆ¶ä»£ç 
        function copyCode() {
            const codeOutput = document.getElementById('codeOutput');
            const text = codeOutput.textContent;
            if (text === 'ç‚¹å‡»"ç”Ÿæˆè„šæœ¬"æŒ‰é’®æ¥ç”Ÿæˆæ–‡çŒ®çŸ©é˜µè„šæœ¬...') {
                alert('è¯·å…ˆç”Ÿæˆè„šæœ¬ï¼');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                alert('è„šæœ¬ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
            });
        }

        // ä¸‹è½½è„šæœ¬
        function downloadScript() {
            const codeOutput = document.getElementById('codeOutput');
            const text = codeOutput.textContent;
            if (text === 'ç‚¹å‡»"ç”Ÿæˆè„šæœ¬"æŒ‰é’®æ¥ç”Ÿæˆæ–‡çŒ®çŸ©é˜µè„šæœ¬...') {
                alert('è¯·å…ˆç”Ÿæˆè„šæœ¬ï¼');
                return;
            }
            
            const blob = new Blob([text], { type: 'text/javascript;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'matrix-script.js';
            link.click();
            URL.revokeObjectURL(url);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', initializeFields);
    </script>
</body>
</html>
