<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>浅色知识图谱可视化（含图例+样式导入导出+换行支持）</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* ---------- 1. 浅色主题 + 左右布局（优化左侧紧密性） ---------- */
        :root{
            --bg:#f5f7fa;
            --panel:#ffffff;
            --text:#333333;
            --border:#d0d0d0;
            --primary:#4c6ef5;
            --hover:#364fc7;
        }
        html,body{
            height:100%;
            margin:0;
            font-family:"Times New Roman", 宋体, SimSun, serif;
            background:var(--bg);
            color:var(--text);
        }
        .wrapper{
            display:flex;
            height:100%;
            gap:12px; /* 减小左右面板间距 */
            padding:12px; /* 减小页面内边距 */
            box-sizing:border-box;
        }
        /* 左侧控制面板（核心优化：紧密布局） */
        .left{
            width:320px; /* 小幅缩窄宽度，提升整体紧凑感 */
            background:var(--panel);
            border:1px solid var(--border);
            border-radius:8px;
            padding:16px; /* 减小内边距 */
            display:flex;
            flex-direction:column;
            gap:10px; /* 减小内部模块间距（关键） */
            overflow:auto;
            box-shadow:0 2px 6px rgba(0,0,0,.04); /* 减弱阴影，更简洁 */
        }
        .left h3{
            margin:0; /* 取消上下外边距，更紧凑 */
            font-weight:500;
            font-size:15px; /* 小幅缩小标题字体 */
            display:flex;
            align-items:center;
        }
        /* 标题前加小图标（可选，提升辨识度） */
        .left h3::before{
            content:'';
            width:4px;
            height:15px;
            background:var(--primary);
            margin-right:8px;
            border-radius:2px;
        }
        textarea{
            width:100%;
            height:280px; /* 大幅增加输入框高度（核心需求） */
            resize:vertical;
            padding:8px;
            border:1px solid var(--border);
            border-radius:4px;
            font-size:13px; /* 小幅缩小字体，容纳更多内容 */
            font-family:inherit;
            white-space:pre; /* 保留制表符、换行符 */
            line-height:1.4; /* 优化行高，更紧凑 */
            box-sizing:border-box;
        }
        .buttons{
            display:flex;
            gap:6px; /* 减小按钮间距 */
            height:36px; /* 固定按钮高度，更规整 */
        }
        button{
            flex:1;
            padding:6px 8px; /* 减小按钮内边距 */
            border:none;
            border-radius:4px;
            background:var(--primary);
            color:#fff;
            cursor:pointer;
            font-size:13px; /* 缩小按钮字体 */
            font-family:inherit;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        button:hover{background:var(--hover);}
        /* 样式配置区（压缩冗余空间） */
        .style-box{
            border:1px solid var(--border);
            border-radius:4px;
            padding:10px; /* 减小内边距 */
            font-size:13px; /* 缩小字体 */
            box-sizing:border-box;
        }
        .style-item{
            display:flex;
            align-items:center;
            gap:6px; /* 减小项目间距 */
            margin:4px 0; /* 减小上下间距 */
        }
        .style-item label{
            min-width:70px; /* 缩小标签宽度 */
            font-size:12px; /* 缩小标签字体 */
            font-family:inherit;
        }
        input[type=color]{
            width:32px; /* 缩小颜色选择器 */
            height:22px;
            padding:0;
            border:1px solid var(--border);
            border-radius:3px;
            cursor:pointer;
        }
        input[type=number]{
            width:60px; /* 缩小数字输入框 */
            padding:3px 5px; /* 减小内边距 */
            border:1px solid var(--border);
            border-radius:3px;
            font-size:12px; /* 缩小字体 */
            font-family:inherit;
            box-sizing:border-box;
        }
        /* 全局开关：隐藏边名（压缩间距） */
        .switch-line{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:6px 0; /* 减小上下内边距 */
            border-top:1px solid var(--border);
            margin-top:4px; /* 减小上边距 */
        }
        .switch-line span{
            font-size:12px; /* 缩小字体 */
            font-family:inherit;
        }
        .switch{
            position:relative;
            width:36px; /* 缩小开关宽度 */
            height:18px; /* 缩小开关高度 */
        }
        .switch input{
            opacity:0;
            width:0;height:0;
        }
        .slider{
            position:absolute;
            inset:0;
            background:#ccc;
            border-radius:18px;
            cursor:pointer;
            transition:.3s;
        }
        .slider:before{
            content:"";
            position:absolute;
            height:12px; /* 缩小开关圆点 */
            width:12px;
            left:3px;
            top:3px;
            background:#fff;
            border-radius:50%;
            transition:.3s;
        }
        input:checked + .slider{background:var(--primary);}
        input:checked + .slider:before{transform:translateX(18px);}

        /* 右侧图表区（保持原有功能） */
        .right{
            flex:1;
            background:var(--panel);
            border:1px solid var(--border);
            border-radius:8px;
            padding:12px; /* 减小内边距 */
            display:flex;
            flex-direction:column;
            box-shadow:0 2px 6px rgba(0,0,0,.04);
            box-sizing:border-box;
        }
        #chart{
            flex:1;
            min-height:0;
        }

        /* 样式导入导出区域（压缩布局） */
        .style-import-export{
            display:flex;
            gap:6px; /* 减小按钮间距 */
            height:34px; /* 固定按钮高度 */
        }
        #importStyleText{
            height:70px; /* 小幅压缩导入文本框 */
            margin-top:4px; /* 减小上边距 */
            font-size:11px; /* 缩小字体 */
            padding:6px; /* 减小内边距 */
            box-sizing:border-box;
        }

        /* 补充：确保 ECharts 图表中的文字样式 */
        .echarts-text {
            font-family:"Times New Roman, 宋体, SimSun, serif !important;
        }
                .author-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 12px;
            color: #9C9C9C;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .author-info:hover {
            opacity: 1;
        }

        .author-info .author-name {
            color: #9C9C9C;
            font-weight: normal;
        }

        .author-info .separator {
            color: #9C9C9C;
        }

        .author-info a {
            color: #9C9C9C;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .author-info a:hover {
            color: #0069E0;
        }
    </style>
<base target="_blank">
</head>
<body>
    <div class="wrapper">
        <!-- 左侧控制（优化后紧密布局） -->
        <div class="left">
            <h3>数据输入（制表符分隔，换行用 \n）</h3>
            <!-- 大幅加高的三元组输入框 -->
            <textarea id="dataInput" placeholder="targetu_16	interacted	i_9\nOlive Garden Gift Card">targetu_16	interacted	i_9\nOlive Garden Gift Card
u_68	interacted	i_0\nBrinker Gift Card
u_68	interacted	i_4\nChili's Gift Card
i_9\nOlive Garden Gift Card	has	a_4245\nFood Gifts
i_0\nBrinker Gift Card	has	a_4245\nFood Gifts
i_4\nChili's Gift Card	has	a_4245\nFood Gifts
testi_8\nBuca di Beppo Gift Card	has	a_4245\nFood Gifts</textarea>
            <div class="buttons">
                <button onclick="updateGraph()">更新图谱</button>
                <button onclick="exportSVG()">导出SVG</button>
            </div>

            <h3>样式配置</h3>
            <div id="styleConfig" class="style-box"></div>

            <h3>样式导入/导出</h3>
            <textarea id="importStyleText" placeholder="粘贴Excel制表符数据&#10;格式：名称	色码	大小/宽度"></textarea>
            <div class="style-import-export">
                <button onclick="copyStylesToClipboard()">复制样式</button>
                <button onclick="importStylesFromClipboard()">导入样式</button>
            </div>

            <div class="switch-line">
                <span>显示关系名称</span>
                <label class="switch">
                    <input type="checkbox" id="edgeLabelSwitch" checked onchange="toggleEdgeLabel()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- 右侧图表 -->
        <div class="right">
            <div id="chart"></div>
        </div>
    </div>

    <script>
        /* ---------- 2. 初始化 & 数据解析（支持 \n 换行） ---------- */
        let myChart;
        let entityColors={},relationColors={},entitySizes={},relationWidths={};
        let currentOption={};          // 保存当前 option，方便开关边名时复用
        let showEdgeLabel=true;        // 全局开关状态

        function initChart(){
            const dom=document.getElementById('chart');
            myChart=echarts.init(dom,null,{renderer:'svg'});
        }
        function parseData(text){
            const lines=text.trim().split('\n');
            const entities=new Set(),relations=new Set(),links=[];
            lines.forEach(l=>{
                // 按制表符分割，保留实体内部的 \n（不会被分割）
                const p=l.trim().split(/\t+/);
                if(p.length>=3){
                    const[s,r,t]=p; 
                    // 替换 \n 为实际换行符（输入框中写的 \n 是字符串，需转义为真正的换行）
                    const source = s.replace(/\\n/g, '\n');
                    const target = t.replace(/\\n/g, '\n');
                    const relation = r.replace(/\\n/g, '\n'); // 关系也支持换行（可选）
                    entities.add(source);entities.add(target);relations.add(relation);
                    links.push({source:source,target:target,relation:relation});
                }
            });
            return {entities:[...entities],relations:[...relations],links};
        }
        // 优化实体类型识别（忽略 \n 后的内容，只取 _ 前的前缀）
        function getEntityType(e){return e.split('_')[0].split('\n')[0];}

        /* ---------- 3. 样式配置面板 ---------- */
        function updateStyleConfig({entities,relations}){
            const box=document.getElementById('styleConfig');
            box.innerHTML='';
            /* 实体 */
            const etypes=[...new Set(entities.map(getEntityType))];
            etypes.forEach((t,i)=>{
                if(!entityColors[t]){entityColors[t]=genColor(i);entitySizes[t]=50;} // 适当增大节点大小，容纳换行文字
                box.innerHTML+=`
                <div class="style-item">
                    <label>${t}</label>
                    <input type="color" value="${entityColors[t]}" onchange="updateEColor('${t}',this.value)">
                    <input type="number" min="30" max="120" value="${entitySizes[t]}" onchange="updateESize('${t}',this.value)">
                </div>`;
            });
            /* 关系 */
            relations.forEach((r,i)=>{
                if(!relationColors[r]){relationColors[r]=genColor(i+100);relationWidths[r]=2;}
                box.innerHTML+=`
                <div class="style-item">
                    <label>${r}</label>
                    <input type="color" value="${relationColors[r]}" onchange="updateRColor('${r}',this.value)">
                    <input type="number" min="1" max="8" value="${relationWidths[r]}" onchange="updateRWidth('${r}',this.value)">
                </div>`;
            });
        }
        function genColor(idx){
            const colors=['#ff6b6b','#4ecdc4','#45b7d1','#f9ca24','#6c5ce7','#a29bfe','#fd79a8','#00cec9','#e17055','#74b9ff'];
            return colors[idx%colors.length];
        }
        function updateEColor(t,c){
            entityColors[t]=c;
            if(currentOption.series && currentOption.series[0].categories){
                currentOption.series[0].categories.forEach(cat => {
                    if(cat.name === t) cat.itemStyle.color = c;
                });
                currentOption.series[0].data.forEach(node => {
                    if(node.category === t) node.itemStyle.color = c;
                });
                myChart.setOption(currentOption);
            }
        }
        function updateESize(t,s){
            entitySizes[t]=+s;
            if(currentOption.series && currentOption.series[0].data){
                currentOption.series[0].data.forEach(node => {
                    if(node.category === t) node.symbolSize = +s;
                });
                myChart.setOption(currentOption);
            }
        }
        function updateRColor(t,c){
            relationColors[t]=c;
            if(currentOption.series && currentOption.series[0].links){
                currentOption.series[0].links.forEach(link => {
                    if(link.relation === t) link.lineStyle.color = c;
                });
                myChart.setOption(currentOption);
            }
        }
        function updateRWidth(t,w){
            relationWidths[t]=+w;
            if(currentOption.series && currentOption.series[0].links){
                currentOption.series[0].links.forEach(link => {
                    if(link.relation === t) link.lineStyle.width = +w;
                });
                myChart.setOption(currentOption);
            }
        }

        /* ---------- 4. 一键隐藏/显示边名 ---------- */
        function toggleEdgeLabel(){
            showEdgeLabel=document.getElementById('edgeLabelSwitch').checked;
            if(!currentOption.series)return;
            currentOption.series[0].links.forEach(edge=>{
                edge.label.show=showEdgeLabel;
            });
            myChart.setOption(currentOption);
        }

        /* ---------- 5. 更新图谱（优化换行显示） ---------- */
        function updateGraph(){
            const {entities,relations,links}=parseData(document.getElementById('dataInput').value);
            updateStyleConfig({entities,relations});

            const categories=[...new Set(entities.map(getEntityType))].map(t=>({
                name:t,
                itemStyle:{color:entityColors[t]||genColor(0)}
            }));
            
            const nodes=entities.map(e=>{
                const t=getEntityType(e);
                return {
                    id:e,
                    name:e, // 保留 \n 换行符，ECharts 会自动渲染为多行
                    category:t,
                    symbolSize:entitySizes[t]||50, // 增大节点，避免文字溢出
                    itemStyle:{color:entityColors[t]||genColor(0)},
                    label:{
                        show:true,
                        fontSize:11, // 适当缩小字体，容纳更多行
                        color:'#333',
                        fontFamily:"Times New Roman, 宋体, SimSun, serif",
                        breakAll: true, // 强制换行（关键）
                        lineHeight: 18, // 行高，控制换行后文字间距
                        padding: [4, 2] // 内边距，避免文字贴边
                    },
                    draggable: true
                };
            });

            const edges=links.map(l=>{
                const r=l.relation;
                return {
                    source:l.source,
                    target:l.target,
                    relation:r,
                    value:r,
                    lineStyle:{
                        color:relationColors[r]||genColor(0),
                        width:relationWidths[r]||2,
                        curveness:0.2
                    },
                    label:{
                        show:showEdgeLabel,
                        formatter:r,
                        fontSize:12,
                        color:'#555',
                        fontFamily:"Times New Roman, 宋体, SimSun, serif",
                        backgroundColor:'rgba(255,255,255,0.8)',
                        padding:[2,4],
                        borderRadius:2
                    }
                };
            });

            currentOption={
                tooltip:{
                    trigger:'item',
                    backgroundColor:'#fff',
                    borderColor:'#ccc',
                    textStyle:{color:'#333',fontFamily:"Times New Roman, 宋体, SimSun, serif"},
                    formatter:function(params){
                        if(params.dataType === 'node'){
                            return `类型：${params.data.category}<br>名称：${params.data.name.replace(/\n/g, '<br>')}`;
                        }else if(params.dataType === 'edge'){
                            return `关系：${params.data.relation}<br>来源：${params.data.source.replace(/\n/g, '<br>')}<br>目标：${params.data.target.replace(/\n/g, '<br>')}`;
                        }
                    }
                },
                legend: {
                    show: true,
                    type: 'scroll',
                    data: categories.map(cat => cat.name),
                    top: 10,
                    left: 'center',
                    textStyle: {color: '#333',fontSize: 12,fontFamily:"Times New Roman, 宋体, SimSun, serif"},
                    backgroundColor: 'rgba(255,255,255,0.9)',
                    padding: [8, 16],
                    borderRadius: 4,
                    itemWidth: 12,
                    itemHeight: 12,
                    gap: 15,
                    pageButtonStyle: {color: '#666',borderColor: '#ddd'}
                },
                series:[{
                    type:'graph',
                    layout:'force',
                    data:nodes,
                    links:edges,
                    categories:categories,
                    roam:true,
                    force:{
                        repulsion: 1500, // 增大排斥力，避免换行后节点重叠
                        edgeLength: 250, // 调整边长度，适配换行后的节点大小
                        gravity: 0.1,
                        layoutAnimation: true
                    },
                    emphasis:{
                        focus:'adjacency',
                        lineStyle:{width:6},
                        itemStyle:{shadowBlur: 15,shadowColor: 'rgba(76,110,245,0.6)'}
                    },
                    animationDuration: 1000,
                    animationEasingUpdate: 'quinticInOut'
                }]
            };

            myChart.setOption(currentOption,true);
        }

        /* ---------- 6. 导出SVG ---------- */
        function exportSVG(){
            const url=myChart.getDataURL({type:'svg',pixelRatio:2,backgroundColor:'#fff'});
            const a=document.createElement('a');
            a.download='knowledge_graph.svg';
            a.href=url;
            a.click();
        }

        /* ---------- 7. 样式导入导出功能 ---------- */
        function copyStylesToClipboard(){
            let styleText = "";
            // 复制实体样式（替换 \n 为 \\n，避免Excel中自动换行导致格式错乱）
            Object.keys(entityColors).forEach(type => {
                const safeType = type.replace(/\n/g, '\\n');
                styleText += `${safeType}\t${entityColors[type]}\t${entitySizes[type] || 50}\n`;
            });
            // 复制关系样式
            Object.keys(relationColors).forEach(relation => {
                const safeRelation = relation.replace(/\n/g, '\\n');
                styleText += `${safeRelation}\t${relationColors[relation]}\t${relationWidths[relation] || 2}\n`;
            });
            navigator.clipboard.writeText(styleText.trim()).then(() => {
                alert("样式已复制到剪贴板！");
            }).catch(err => {
                console.error('复制失败:', err);
                alert("复制失败，请手动复制文本框内容");
            });
        }

        function importStylesFromClipboard(){
            const importText = document.getElementById('importStyleText').value.trim();
            if(!importText){
                alert("请先在文本框中粘贴样式数据");
                return;
            }
            const lines = importText.split('\n');
            let successCount = 0;
            lines.forEach(line => {
                const parts = line.trim().split(/\t+/);
                if(parts.length === 3){
                    let [name, color, sizeOrWidth] = parts;
                    // 还原 \n（将Excel中保存的 \\n 转回 \n）
                    name = name.replace(/\\n/g, '\n');
                    const value = Number(sizeOrWidth);
                    if(Object.keys(entityColors).includes(name)){
                        entityColors[name] = color;
                        if(!isNaN(value) && value >=30 && value <=120){
                            entitySizes[name] = value;
                        }
                        successCount++;
                    }else if(Object.keys(relationColors).includes(name)){
                        relationColors[name] = color;
                        if(!isNaN(value) && value >=1 && value <=8){
                            relationWidths[name] = value;
                        }
                        successCount++;
                    }
                }
            });
            updateGraph();
            alert(`导入成功！共导入 ${successCount} 条样式`);
        }

        /* ---------- 8. 启动 ---------- */
        window.onload=()=>{initChart();updateGraph();};
        window.addEventListener('resize',()=>myChart.resize());
    </script>
        <!-- 作者信息 -->
    <div class="author-info">
        <span class="author-name">作者: Stream-L</span>
        <span class="separator">|</span>
        <a href="https://stream-l.github.io/" target="_blank" rel="noopener">博客</a>
    </div>
</body>
</html>
